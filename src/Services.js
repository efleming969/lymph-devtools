"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const Typescript = require("typescript");
const Glob = require("globby");
const FS = require("fs-extra");
const Path = require("path");
const Archiver = require("archiver");
exports.uploadFunction = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const s3 = new aws_sdk_1.S3({ region: config.region });
        const bundle_name = `${config.namespace}--${module_name}`;
        FS.readFile(`${config.buildDir}/${bundle_name}.zip`)
            .then(function (buffer) {
            return {
                Body: buffer,
                Bucket: `${config.namespace}-artifacts`,
                Key: `${bundle_name}.zip`
            };
        }).then(put_config => s3.putObject(put_config).promise());
    }));
};
exports.updateFunction = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name,
            S3Bucket: `${config.namespace}-artifacts`,
            S3Key: `${function_name}.zip`
        };
        return lambda.updateFunctionCode(update_config).promise();
    }));
};
exports.detect = function (config) {
    return Glob(Path.join(config.sourceDir, "*.ts"));
};
exports.compile = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const service_name = Path.basename(service_file, ".ts");
        const compile_options = {
            noEmitOnError: true,
            noImplicitAny: false,
            target: Typescript.ScriptTarget.ES2015,
            module: Typescript.ModuleKind.CommonJS,
            moduleResolution: Typescript.ModuleResolutionKind.NodeJs,
            inlineSourceMap: false,
            inlineSources: false,
            outDir: Path.join(config.buildDir, service_name)
        };
        const program = Typescript.createProgram([service_file], compile_options);
        return new Promise(function (resolve, reject) {
            const emitResult = program.emit();
            const allDiagnostics = Typescript.getPreEmitDiagnostics(program)
                .concat(emitResult.diagnostics);
            const results = allDiagnostics.map(function (diagnostic) {
                if (diagnostic.file) {
                    let { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                    let message = Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                    return `${diagnostic.file.fileName} (${line + 1},${character + 1}): ${message}`;
                }
                else {
                    return `${Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n')}`;
                }
            });
            results.length > 0 ? reject(results) : resolve();
        });
    }));
};
exports.bundle = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const bundle_name = Path.basename(service_file, ".ts");
        const archive = Archiver("zip");
        const artifact_file = `${config.namespace}--${bundle_name}.zip`;
        return new Promise(function (resolve, reject) {
            const output = FS.createWriteStream(Path.join(config.buildDir, artifact_file));
            archive.on("error", function (err) {
                reject(err);
            });
            output.on("close", function () {
                resolve(bundle_name);
            });
            archive.directory(Path.join(config.buildDir, bundle_name), "");
            archive.pipe(output);
            archive.finalize();
        });
    }));
};
exports.build = function (config) {
    return exports.detect(config)
        .then(output => console.dir(output))
        .catch(e => console.log(e));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvQztBQUVwQyx5Q0FBd0M7QUFDeEMsK0JBQThCO0FBQzlCLCtCQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIscUNBQW9DO0FBU3ZCLFFBQUEsY0FBYyxHQUFHLFVBQVcsTUFBb0IsRUFBRSxRQUFrQjtJQUM3RSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxRQUFRLENBQUMsR0FBRyxDQUFFLFVBQVcsWUFBWTtRQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFFLFlBQVksRUFBRSxLQUFLLENBQUUsQ0FBQTtRQUN4RCxNQUFNLEVBQUUsR0FBRyxJQUFJLFlBQUUsQ0FBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtRQUM5QyxNQUFNLFdBQVcsR0FBRyxHQUFJLE1BQU0sQ0FBQyxTQUFVLEtBQU0sV0FBWSxFQUFFLENBQUE7UUFFN0QsRUFBRSxDQUFDLFFBQVEsQ0FBRSxHQUFJLE1BQU0sQ0FBQyxRQUFTLElBQUssV0FBWSxNQUFNLENBQUU7YUFDckQsSUFBSSxDQUFFLFVBQVcsTUFBTTtZQUNwQixNQUFNLENBQUM7Z0JBQ0gsSUFBSSxFQUFFLE1BQU07Z0JBQ1osTUFBTSxFQUFFLEdBQUksTUFBTSxDQUFDLFNBQVUsWUFBWTtnQkFDekMsR0FBRyxFQUFFLEdBQUksV0FBWSxNQUFNO2FBQzlCLENBQUE7UUFDTCxDQUFDLENBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFFLFVBQVUsQ0FBRSxDQUFDLE9BQU8sRUFBRSxDQUFFLENBQUE7SUFDdEUsQ0FBQyxDQUFFLENBQUUsQ0FBQTtBQUNULENBQUMsQ0FBQTtBQUVZLFFBQUEsY0FBYyxHQUFHLFVBQVcsTUFBb0IsRUFBRSxRQUFrQjtJQUM3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QUE7WUFFSCxPQUFPLENBQUMsU0FBUyxDQUFFLElBQUksQ0FBQyxJQUFJLENBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUUsRUFBRSxFQUFFLENBQUUsQ0FBQTtZQUVsRSxPQUFPLENBQUMsSUFBSSxDQUFFLE1BQU0sQ0FBRSxDQUFBO1lBQ3RCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN0QixDQUFDLENBQUUsQ0FBQTtJQUNQLENBQUMsQ0FBRSxDQUFFLENBQUE7QUFDVCxDQUFDLENBQUE7QUFFWSxRQUFBLEtBQUssR0FBRyxVQUFXLE1BQU07SUFDbEMsTUFBTSxDQUFDLGNBQU0sQ0FBRSxNQUFNLENBQUU7U0FJbEIsSUFBSSxDQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxNQUFNLENBQUUsQ0FBRTtTQUN2QyxLQUFLLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBRSxDQUFFLENBQUE7QUFDdkMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGFtYmRhLCBTMyB9IGZyb20gXCJhd3Mtc2RrXCJcblxuaW1wb3J0ICogYXMgVHlwZXNjcmlwdCBmcm9tIFwidHlwZXNjcmlwdFwiXG5pbXBvcnQgKiBhcyBHbG9iIGZyb20gXCJnbG9iYnlcIlxuaW1wb3J0ICogYXMgRlMgZnJvbSBcImZzLWV4dHJhXCJcbmltcG9ydCAqIGFzIFBhdGggZnJvbSBcInBhdGhcIlxuaW1wb3J0ICogYXMgQXJjaGl2ZXIgZnJvbSBcImFyY2hpdmVyXCJcblxuZXhwb3J0IHR5cGUgQnVuZGxlQ29uZmlnID0ge1xuICAgIG5hbWVzcGFjZTogc3RyaW5nLFxuICAgIGJ1aWxkRGlyOiBzdHJpbmdcbiAgICBzb3VyY2VEaXI6IHN0cmluZyxcbiAgICByZWdpb246IHN0cmluZ1xufVxuXG5leHBvcnQgY29uc3QgdXBsb2FkRnVuY3Rpb24gPSBmdW5jdGlvbiAoIGNvbmZpZzogQnVuZGxlQ29uZmlnLCBzZXJ2aWNlczogc3RyaW5nW10gKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBtb2R1bGVfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG4gICAgICAgIGNvbnN0IHMzID0gbmV3IFMzKCB7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9IClcbiAgICAgICAgY29uc3QgYnVuZGxlX25hbWUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBtb2R1bGVfbmFtZSB9YFxuXG4gICAgICAgIEZTLnJlYWRGaWxlKCBgJHsgY29uZmlnLmJ1aWxkRGlyIH0vJHsgYnVuZGxlX25hbWUgfS56aXBgIClcbiAgICAgICAgICAgIC50aGVuKCBmdW5jdGlvbiAoIGJ1ZmZlciApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBCb2R5OiBidWZmZXIsXG4gICAgICAgICAgICAgICAgICAgIEJ1Y2tldDogYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS1hcnRpZmFjdHNgLFxuICAgICAgICAgICAgICAgICAgICBLZXk6IGAkeyBidW5kbGVfbmFtZSB9LnppcGBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICkudGhlbiggcHV0X2NvbmZpZyA9PiBzMy5wdXRPYmplY3QoIHB1dF9jb25maWcgKS5wcm9taXNlKCkgKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVGdW5jdGlvbiA9IGZ1bmN0aW9uICggY29uZmlnOiBCdW5kbGVDb25maWcsIHNlcnZpY2VzOiBzdHJpbmdbXSApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgbGFtYmRhID0gbmV3IExhbWJkYSggeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSApXG4gICAgICAgIGNvbnN0IGZ1bmN0aW9uX25hbWUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBtb2R1bGVfbmFtZSB9YFxuXG4gICAgICAgIGNvbnN0IHVwZGF0ZV9jb25maWcgPSB7XG4gICAgICAgICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uX25hbWUsXG4gICAgICAgICAgICBTM0J1Y2tldDogYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS1hcnRpZmFjdHNgLFxuICAgICAgICAgICAgUzNLZXk6IGAkeyBmdW5jdGlvbl9uYW1lIH0uemlwYFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGxhbWJkYS51cGRhdGVGdW5jdGlvbkNvZGUoIHVwZGF0ZV9jb25maWcgKS5wcm9taXNlKClcbiAgICB9ICkgKVxufVxuXG5leHBvcnQgY29uc3QgZGV0ZWN0ID0gZnVuY3Rpb24gKCBjb25maWc6IEJ1bmRsZUNvbmZpZyApOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIEdsb2IoIFBhdGguam9pbiggY29uZmlnLnNvdXJjZURpciwgXCIqLnRzXCIgKSApXG59XG5cbmV4cG9ydCBjb25zdCBjb21waWxlID0gZnVuY3Rpb24gKCBjb25maWc6IEJ1bmRsZUNvbmZpZywgc2VydmljZXM6IHN0cmluZ1tdICk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBzZXJ2aWNlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuXG4gICAgICAgIGNvbnN0IGNvbXBpbGVfb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG5vRW1pdE9uRXJyb3I6IHRydWUsXG4gICAgICAgICAgICBub0ltcGxpY2l0QW55OiBmYWxzZSxcbiAgICAgICAgICAgIHRhcmdldDogVHlwZXNjcmlwdC5TY3JpcHRUYXJnZXQuRVMyMDE1LFxuICAgICAgICAgICAgbW9kdWxlOiBUeXBlc2NyaXB0Lk1vZHVsZUtpbmQuQ29tbW9uSlMsXG4gICAgICAgICAgICBtb2R1bGVSZXNvbHV0aW9uOiBUeXBlc2NyaXB0Lk1vZHVsZVJlc29sdXRpb25LaW5kLk5vZGVKcyxcbiAgICAgICAgICAgIGlubGluZVNvdXJjZU1hcDogZmFsc2UsXG4gICAgICAgICAgICBpbmxpbmVTb3VyY2VzOiBmYWxzZSxcbiAgICAgICAgICAgIG91dERpcjogUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIHNlcnZpY2VfbmFtZSApXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcm9ncmFtID0gVHlwZXNjcmlwdC5jcmVhdGVQcm9ncmFtKCBbIHNlcnZpY2VfZmlsZSBdLCBjb21waWxlX29wdGlvbnMgKVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSggZnVuY3Rpb24gKCByZXNvbHZlLCByZWplY3QgKSB7XG4gICAgICAgICAgICBjb25zdCBlbWl0UmVzdWx0ID0gcHJvZ3JhbS5lbWl0KClcblxuICAgICAgICAgICAgY29uc3QgYWxsRGlhZ25vc3RpY3MgPSBUeXBlc2NyaXB0LmdldFByZUVtaXREaWFnbm9zdGljcyggcHJvZ3JhbSApXG4gICAgICAgICAgICAgICAgLmNvbmNhdCggZW1pdFJlc3VsdC5kaWFnbm9zdGljcyApXG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhbGxEaWFnbm9zdGljcy5tYXAoIGZ1bmN0aW9uICggZGlhZ25vc3RpYyApIHtcbiAgICAgICAgICAgICAgICBpZiAoIGRpYWdub3N0aWMuZmlsZSApIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHsgbGluZSwgY2hhcmFjdGVyIH0gPVxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhZ25vc3RpYy5maWxlLmdldExpbmVBbmRDaGFyYWN0ZXJPZlBvc2l0aW9uKCBkaWFnbm9zdGljLnN0YXJ0IClcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBUeXBlc2NyaXB0LmZsYXR0ZW5EaWFnbm9zdGljTWVzc2FnZVRleHQoIGRpYWdub3N0aWMubWVzc2FnZVRleHQsICdcXG4nIClcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7ZGlhZ25vc3RpYy5maWxlLmZpbGVOYW1lfSAoJHtsaW5lICsgMX0sJHtjaGFyYWN0ZXIgKyAxfSk6ICR7bWVzc2FnZX1gXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7VHlwZXNjcmlwdC5mbGF0dGVuRGlhZ25vc3RpY01lc3NhZ2VUZXh0KCBkaWFnbm9zdGljLm1lc3NhZ2VUZXh0LCAnXFxuJyApfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IClcblxuICAgICAgICAgICAgcmVzdWx0cy5sZW5ndGggPiAwID8gcmVqZWN0KCByZXN1bHRzICkgOiByZXNvbHZlKClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IGJ1bmRsZSA9IGZ1bmN0aW9uICggY29uZmlnOiBCdW5kbGVDb25maWcsIHNlcnZpY2VzOiBzdHJpbmdbXSApOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCggc2VydmljZXMubWFwKCBmdW5jdGlvbiAoIHNlcnZpY2VfZmlsZSApIHtcbiAgICAgICAgY29uc3QgYnVuZGxlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuICAgICAgICBjb25zdCBhcmNoaXZlID0gQXJjaGl2ZXIoIFwiemlwXCIgKVxuICAgICAgICBjb25zdCBhcnRpZmFjdF9maWxlID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgYnVuZGxlX25hbWUgfS56aXBgXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IEZTLmNyZWF0ZVdyaXRlU3RyZWFtKFxuICAgICAgICAgICAgICAgIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBhcnRpZmFjdF9maWxlICkgKVxuXG4gICAgICAgICAgICBhcmNoaXZlLm9uKCBcImVycm9yXCIsIGZ1bmN0aW9uICggZXJyICkge1xuICAgICAgICAgICAgICAgIHJlamVjdCggZXJyIClcbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICBvdXRwdXQub24oIFwiY2xvc2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoIGJ1bmRsZV9uYW1lIClcbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICBhcmNoaXZlLmRpcmVjdG9yeSggUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIGJ1bmRsZV9uYW1lICksIFwiXCIgKVxuXG4gICAgICAgICAgICBhcmNoaXZlLnBpcGUoIG91dHB1dCApXG4gICAgICAgICAgICBhcmNoaXZlLmZpbmFsaXplKClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IGJ1aWxkID0gZnVuY3Rpb24gKCBjb25maWcgKSB7XG4gICAgcmV0dXJuIGRldGVjdCggY29uZmlnIClcbiAgICAvLyAudGhlbiggcHJvbWlzZUFsbCggemlwTW9kdWxlKCBjb25maWcgKSApIClcbiAgICAvLyAudGhlbiggcHJvbWlzZUFsbCggdXBsb2FkRnVuY3Rpb24oIGNvbmZpZyApICkgKVxuICAgIC8vIC50aGVuKCBwcm9taXNlQWxsKCB1cGRhdGVGdW5jdGlvbiggY29uZmlnICkgKSApXG4gICAgICAgIC50aGVuKCBvdXRwdXQgPT4gY29uc29sZS5kaXIoIG91dHB1dCApIClcbiAgICAgICAgLmNhdGNoKCBlID0+IGNvbnNvbGUubG9nKCBlICkgKVxufVxuXG4iXX0=