"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const Typescript = require("typescript");
const Glob = require("globby");
const FS = require("fs-extra");
const Path = require("path");
const Archiver = require("archiver");
exports.uploadFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const s3 = new aws_sdk_1.S3({ region: config.region });
        const bundle_name = `${config.namespace}--${module_name}`;
        console.log("uploading", bundle_name, "to", `${config.namespace}`);
        FS.readFile(`${config.buildDir}/${bundle_name}.zip`)
            .then(function (buffer) {
            return {
                Body: buffer,
                Bucket: `${config.namespace}-artifacts`,
                Key: `${bundle_name}.zip`
            };
        }).then(put_config => s3.putObject(put_config).promise())
            .then(() => service_file);
    }));
};
exports.updateFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name,
            S3Bucket: `${config.namespace}-artifacts`,
            S3Key: `${function_name}.zip`
        };
        console.log("updating", function_name, "from", config.namespace);
        return lambda.updateFunctionCode(update_config)
            .promise().then(() => service_file);
    }));
};
exports.detect = function (config) {
    return Glob(Path.join(config.sourceDir, "*.ts"));
};
exports.compile = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const service_name = Path.basename(service_file, ".ts");
        const compile_options = {
            noEmitOnError: true,
            noImplicitAny: false,
            target: Typescript.ScriptTarget.ES2015,
            module: Typescript.ModuleKind.CommonJS,
            moduleResolution: Typescript.ModuleResolutionKind.NodeJs,
            inlineSourceMap: false,
            inlineSources: false,
            outDir: Path.join(config.buildDir, service_name)
        };
        const program = Typescript.createProgram([service_file], compile_options);
        return new Promise(function (resolve, reject) {
            const emitResult = program.emit();
            const allDiagnostics = Typescript.getPreEmitDiagnostics(program)
                .concat(emitResult.diagnostics);
            const results = allDiagnostics.map(function (diagnostic) {
                if (diagnostic.file) {
                    let { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                    let message = Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                    return `${diagnostic.file.fileName} (${line + 1},${character + 1}): ${message}`;
                }
                else {
                    return `${Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n')}`;
                }
            });
            results.length > 0 ? reject(results) : resolve(service_file);
        });
    }));
};
exports.bundle = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const bundle_name = Path.basename(service_file, ".ts");
        const archive = Archiver("zip");
        const archive_file = `${config.namespace}--${bundle_name}.zip`;
        return new Promise(function (resolve, reject) {
            const output = FS.createWriteStream(Path.join(config.buildDir, archive_file));
            archive.on("error", function (err) {
                reject(err);
            });
            output.on("close", function () {
                resolve(service_file);
            });
            archive.directory(Path.join(config.buildDir, bundle_name), config.namespace);
            archive.pipe(output);
            archive.finalize();
        });
    }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvQztBQUVwQyx5Q0FBd0M7QUFDeEMsK0JBQThCO0FBQzlCLCtCQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIscUNBQW9DO0FBU3ZCLFFBQUEsY0FBYyxHQUFHLENBQUUsTUFBb0IsRUFBRyxFQUFFLENBQUMsVUFBVyxRQUFrQjtJQUNuRixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxRQUFRLENBQUMsR0FBRyxDQUFFLFVBQVcsWUFBWTtRQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFFLFlBQVksRUFBRSxLQUFLLENBQUUsQ0FBQTtRQUN4RCxNQUFNLEVBQUUsR0FBRyxJQUFJLFlBQUUsQ0FBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtRQUM5QyxNQUFNLFdBQVcsR0FBRyxHQUFJLE1BQU0sQ0FBQyxTQUFVLEtBQU0sV0FBWSxFQUFFLENBQUE7UUFFN0QsT0FBTyxDQUFDLEdBQUcsQ0FBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBRSxDQUFBO1FBRXBFLEVBQUUsQ0FBQyxRQUFRLENBQUUsR0FBSSxNQUFNLENBQUMsUUFBUyxJQUFLLFdBQVksTUFBTSxDQUFFO2FBQ3JELElBQUksQ0FBRSxVQUFXLE1BQU07WUFDcEIsTUFBTSxDQUFDO2dCQUNILElBQUksRUFBRSxNQUFNO2dCQUNaLE1BQU0sRUFBRSxHQUFJLE1BQU0sQ0FBQyxTQUFVLFlBQVk7Z0JBQ3pDLEdBQUcsRUFBRSxHQUFJLFdBQVksTUFBTTthQUM5QixDQUFBO1FBQ0wsQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBRSxVQUFVLENBQUUsQ0FBQyxP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LElBQUksT0FBTyxDQUFFLFVBQVcsT0FBTyxFQUFFLE1BQU07WUFDMUMsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUMvQixJQUFJLENBQUMsSUFBSSxDQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFFLENBQUUsQ0FBQTtZQUVoRCxPQUFPLENBQUMsRUFBRSxDQUFFLE9BQU8sRUFBRSxVQUFXLEdBQUc7Z0JBQy9CLE1BQU0sQ0FBRSxHQUFHLENBQUUsQ0FBQTtZQUNqQixDQUFDLENBQUUsQ0FBQTtZQUVILE1BQU0sQ0FBQyxFQUFFLENBQUUsT0FBTyxFQUFFO2dCQUNoQixPQUFPLENBQUUsWUFBWSxDQUFFLENBQUE7WUFDM0IsQ0FBQyxDQUFFLENBQUE7WUFFSCxPQUFPLENBQUMsU0FBUyxDQUFFLElBQUksQ0FBQyxJQUFJLENBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUUsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFFLENBQUE7WUFFaEYsT0FBTyxDQUFDLElBQUksQ0FBRSxNQUFNLENBQUUsQ0FBQTtZQUN0QixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDdEIsQ0FBQyxDQUFFLENBQUE7SUFDUCxDQUFDLENBQUUsQ0FBRSxDQUFBO0FBQ1QsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGFtYmRhLCBTMyB9IGZyb20gXCJhd3Mtc2RrXCJcblxuaW1wb3J0ICogYXMgVHlwZXNjcmlwdCBmcm9tIFwidHlwZXNjcmlwdFwiXG5pbXBvcnQgKiBhcyBHbG9iIGZyb20gXCJnbG9iYnlcIlxuaW1wb3J0ICogYXMgRlMgZnJvbSBcImZzLWV4dHJhXCJcbmltcG9ydCAqIGFzIFBhdGggZnJvbSBcInBhdGhcIlxuaW1wb3J0ICogYXMgQXJjaGl2ZXIgZnJvbSBcImFyY2hpdmVyXCJcblxuZXhwb3J0IHR5cGUgQnVuZGxlQ29uZmlnID0ge1xuICAgIG5hbWVzcGFjZTogc3RyaW5nLFxuICAgIGJ1aWxkRGlyOiBzdHJpbmdcbiAgICBzb3VyY2VEaXI6IHN0cmluZyxcbiAgICByZWdpb246IHN0cmluZ1xufVxuXG5leHBvcnQgY29uc3QgdXBsb2FkRnVuY3Rpb24gPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBtb2R1bGVfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG4gICAgICAgIGNvbnN0IHMzID0gbmV3IFMzKCB7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9IClcbiAgICAgICAgY29uc3QgYnVuZGxlX25hbWUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBtb2R1bGVfbmFtZSB9YFxuXG4gICAgICAgIGNvbnNvbGUubG9nKCBcInVwbG9hZGluZ1wiLCBidW5kbGVfbmFtZSwgXCJ0b1wiLCBgJHtjb25maWcubmFtZXNwYWNlfWAgKVxuXG4gICAgICAgIEZTLnJlYWRGaWxlKCBgJHsgY29uZmlnLmJ1aWxkRGlyIH0vJHsgYnVuZGxlX25hbWUgfS56aXBgIClcbiAgICAgICAgICAgIC50aGVuKCBmdW5jdGlvbiAoIGJ1ZmZlciApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBCb2R5OiBidWZmZXIsXG4gICAgICAgICAgICAgICAgICAgIEJ1Y2tldDogYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS1hcnRpZmFjdHNgLFxuICAgICAgICAgICAgICAgICAgICBLZXk6IGAkeyBidW5kbGVfbmFtZSB9LnppcGBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICkudGhlbiggcHV0X2NvbmZpZyA9PiBzMy5wdXRPYmplY3QoIHB1dF9jb25maWcgKS5wcm9taXNlKCkgKVxuICAgICAgICAgICAgLnRoZW4oICgpID0+IHNlcnZpY2VfZmlsZSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IHVwZGF0ZUZ1bmN0aW9uID0gKCBjb25maWc6IEJ1bmRsZUNvbmZpZyApID0+IGZ1bmN0aW9uICggc2VydmljZXM6IHN0cmluZ1tdICkge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCggc2VydmljZXMubWFwKCBmdW5jdGlvbiAoIHNlcnZpY2VfZmlsZSApIHtcbiAgICAgICAgY29uc3QgbW9kdWxlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuICAgICAgICBjb25zdCBsYW1iZGEgPSBuZXcgTGFtYmRhKCB7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9IClcbiAgICAgICAgY29uc3QgZnVuY3Rpb25fbmFtZSA9IGAkeyBjb25maWcubmFtZXNwYWNlIH0tLSR7IG1vZHVsZV9uYW1lIH1gXG5cbiAgICAgICAgY29uc3QgdXBkYXRlX2NvbmZpZyA9IHtcbiAgICAgICAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25fbmFtZSxcbiAgICAgICAgICAgIFMzQnVja2V0OiBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LWFydGlmYWN0c2AsXG4gICAgICAgICAgICBTM0tleTogYCR7IGZ1bmN0aW9uX25hbWUgfS56aXBgXG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZyggXCJ1cGRhdGluZ1wiLCBmdW5jdGlvbl9uYW1lLCBcImZyb21cIiwgY29uZmlnLm5hbWVzcGFjZSApXG5cbiAgICAgICAgcmV0dXJuIGxhbWJkYS51cGRhdGVGdW5jdGlvbkNvZGUoIHVwZGF0ZV9jb25maWcgKVxuICAgICAgICAgICAgLnByb21pc2UoKS50aGVuKCAoKSA9PiBzZXJ2aWNlX2ZpbGUgKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBkZXRlY3QgPSBmdW5jdGlvbiAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gR2xvYiggUGF0aC5qb2luKCBjb25maWcuc291cmNlRGlyLCBcIioudHNcIiApIClcbn1cblxuZXhwb3J0IGNvbnN0IGNvbXBpbGUgPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IHNlcnZpY2VfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG5cbiAgICAgICAgY29uc3QgY29tcGlsZV9vcHRpb25zID0ge1xuICAgICAgICAgICAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgICAgICAgICAgIG5vSW1wbGljaXRBbnk6IGZhbHNlLFxuICAgICAgICAgICAgdGFyZ2V0OiBUeXBlc2NyaXB0LlNjcmlwdFRhcmdldC5FUzIwMTUsXG4gICAgICAgICAgICBtb2R1bGU6IFR5cGVzY3JpcHQuTW9kdWxlS2luZC5Db21tb25KUyxcbiAgICAgICAgICAgIG1vZHVsZVJlc29sdXRpb246IFR5cGVzY3JpcHQuTW9kdWxlUmVzb2x1dGlvbktpbmQuTm9kZUpzLFxuICAgICAgICAgICAgaW5saW5lU291cmNlTWFwOiBmYWxzZSxcbiAgICAgICAgICAgIGlubGluZVNvdXJjZXM6IGZhbHNlLFxuICAgICAgICAgICAgb3V0RGlyOiBQYXRoLmpvaW4oIGNvbmZpZy5idWlsZERpciwgc2VydmljZV9uYW1lIClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb2dyYW0gPSBUeXBlc2NyaXB0LmNyZWF0ZVByb2dyYW0oIFsgc2VydmljZV9maWxlIF0sIGNvbXBpbGVfb3B0aW9ucyApXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IGVtaXRSZXN1bHQgPSBwcm9ncmFtLmVtaXQoKVxuXG4gICAgICAgICAgICBjb25zdCBhbGxEaWFnbm9zdGljcyA9IFR5cGVzY3JpcHQuZ2V0UHJlRW1pdERpYWdub3N0aWNzKCBwcm9ncmFtIClcbiAgICAgICAgICAgICAgICAuY29uY2F0KCBlbWl0UmVzdWx0LmRpYWdub3N0aWNzIClcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IGFsbERpYWdub3N0aWNzLm1hcCggZnVuY3Rpb24gKCBkaWFnbm9zdGljICkge1xuICAgICAgICAgICAgICAgIGlmICggZGlhZ25vc3RpYy5maWxlICkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgeyBsaW5lLCBjaGFyYWN0ZXIgfSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFnbm9zdGljLmZpbGUuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24oIGRpYWdub3N0aWMuc3RhcnQgKVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID1cbiAgICAgICAgICAgICAgICAgICAgICAgIFR5cGVzY3JpcHQuZmxhdHRlbkRpYWdub3N0aWNNZXNzYWdlVGV4dCggZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCwgJ1xcbicgKVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtkaWFnbm9zdGljLmZpbGUuZmlsZU5hbWV9ICgke2xpbmUgKyAxfSwke2NoYXJhY3RlciArIDF9KTogJHttZXNzYWdlfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtUeXBlc2NyaXB0LmZsYXR0ZW5EaWFnbm9zdGljTWVzc2FnZVRleHQoIGRpYWdub3N0aWMubWVzc2FnZVRleHQsICdcXG4nICl9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICByZXN1bHRzLmxlbmd0aCA+IDAgPyByZWplY3QoIHJlc3VsdHMgKSA6IHJlc29sdmUoIHNlcnZpY2VfZmlsZSApXG4gICAgICAgIH0gKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBidW5kbGUgPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZSA9IEFyY2hpdmVyKCBcInppcFwiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZV9maWxlID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgYnVuZGxlX25hbWUgfS56aXBgXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IEZTLmNyZWF0ZVdyaXRlU3RyZWFtKFxuICAgICAgICAgICAgICAgIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBhcmNoaXZlX2ZpbGUgKSApXG5cbiAgICAgICAgICAgIGFyY2hpdmUub24oIFwiZXJyb3JcIiwgZnVuY3Rpb24gKCBlcnIgKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCBlcnIgKVxuICAgICAgICAgICAgfSApXG5cbiAgICAgICAgICAgIG91dHB1dC5vbiggXCJjbG9zZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSggc2VydmljZV9maWxlIClcbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICBhcmNoaXZlLmRpcmVjdG9yeSggUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIGJ1bmRsZV9uYW1lICksIGNvbmZpZy5uYW1lc3BhY2UgKVxuXG4gICAgICAgICAgICBhcmNoaXZlLnBpcGUoIG91dHB1dCApXG4gICAgICAgICAgICBhcmNoaXZlLmZpbmFsaXplKClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuIl19