"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const Typescript = require("typescript");
const Glob = require("globby");
const FS = require("fs-extra");
const Path = require("path");
const Archiver = require("archiver");
exports.uploadFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const s3 = new aws_sdk_1.S3({ region: config.region });
        const bundle_name = `${config.namespace}--${module_name}`;
        console.log("uploading", bundle_name, "to", `${config.namespace}`);
        FS.readFile(`${config.buildDir}/${bundle_name}.zip`)
            .then(function (buffer) {
            return {
                Body: buffer,
                Bucket: `${config.namespace}-artifacts`,
                Key: `${bundle_name}.zip`
            };
        }).then(put_config => s3.putObject(put_config).promise())
            .then(() => service_file);
    }));
};
exports.updateFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name,
            S3Bucket: `${config.namespace}-artifacts`,
            S3Key: `${function_name}.zip`
        };
        console.log("updating", function_name, "from", config.namespace);
        return lambda.updateFunctionCode(update_config).promise();
    }));
};
exports.publishFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name
        };
        console.log("publishing", function_name, config.namespace);
        return lambda.publishVersion(update_config).promise();
    }));
};
exports.detect = function (config) {
    return Glob(Path.join(config.sourceDir, "*.ts"));
};
exports.compile = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const service_name = Path.basename(service_file, ".ts");
        const compile_options = {
            noEmitOnError: true,
            noImplicitAny: false,
            target: Typescript.ScriptTarget.ES2015,
            module: Typescript.ModuleKind.CommonJS,
            moduleResolution: Typescript.ModuleResolutionKind.NodeJs,
            inlineSourceMap: false,
            inlineSources: false,
            outDir: Path.join(config.buildDir, service_name)
        };
        const program = Typescript.createProgram([service_file], compile_options);
        return new Promise(function (resolve, reject) {
            const emitResult = program.emit();
            const allDiagnostics = Typescript.getPreEmitDiagnostics(program)
                .concat(emitResult.diagnostics);
            const results = allDiagnostics.map(function (diagnostic) {
                if (diagnostic.file) {
                    let { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                    let message = Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                    return `${diagnostic.file.fileName} (${line + 1},${character + 1}): ${message}`;
                }
                else {
                    return `${Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n')}`;
                }
            });
            results.length > 0 ? reject(results) : resolve(service_file);
        });
    }));
};
exports.bundle = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const bundle_name = Path.basename(service_file, ".ts");
        const archive = Archiver("zip");
        const archive_file = `${config.namespace}--${bundle_name}.zip`;
        return new Promise(function (resolve, reject) {
            const output = FS.createWriteStream(Path.join(config.buildDir, archive_file));
            archive.on("error", function (err) {
                reject(err);
            });
            output.on("close", function () {
                resolve(service_file);
            });
            archive.directory(Path.join(config.buildDir, bundle_name), config.namespace);
            archive.pipe(output);
            archive.finalize();
        });
    }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvQztBQUVwQyx5Q0FBd0M7QUFDeEMsK0JBQThCO0FBQzlCLCtCQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIscUNBQW9DO0FBU3ZCLFFBQUEsY0FBYyxHQUFHLENBQUUsTUFBb0IsRUFBRyxFQUFFLENBQUMsVUFBVyxRQUFrQjtJQUNuRixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxRQUFRLENBQUMsR0FBRyxDQUFFLFVBQVcsWUFBWTtRQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFFLFlBQVksRUFBRSxLQUFLLENBQUUsQ0FBQTtRQUN4RCxNQUFNLEVBQUUsR0FBRyxJQUFJLFlBQUUsQ0FBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtRQUM5QyxNQUFNLFdBQVcsR0FBRyxHQUFJLE1BQU0sQ0FBQyxTQUFVLEtBQU0sV0FBWSxFQUFFLENBQUE7UUFFN0QsT0FBTyxDQUFDLEdBQUcsQ0FBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBRSxDQUFBO1FBRXBFLEVBQUUsQ0FBQyxRQUFRLENBQUUsR0FBSSxNQUFNLENBQUMsUUFBUyxJQUFLLFdBQVksTUFBTSxDQUFFO2FBQ3JELElBQUksQ0FBRSxVQUFXLE1BQU07WUFDcEIsTUFBTSxDQUFDO2dCQUNILElBQUksRUFBRSxNQUFNO2dCQUNaLE1BQU0sRUFBRSxHQUFJLE1BQU0sQ0FBQyxTQUFVLFlBQVk7Z0JBQ3pDLEdBQUcsRUFBRSxHQUFJLFdBQVksTUFBTTthQUM5QixDQUFBO1FBQ0wsQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBRSxVQUFVLENBQUUsQ0FBQyxP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QUMsUUFBUSxFQUFFLFdBQVcsQ0FBRSxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUUsQ0FBQTtZQUVoRixPQUFPLENBQUMsSUFBSSxDQUFFLE1BQU0sQ0FBRSxDQUFBO1lBQ3RCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN0QixDQUFDLENBQUUsQ0FBQTtJQUNQLENBQUMsQ0FBRSxDQUFFLENBQUE7QUFDVCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMYW1iZGEsIFMzIH0gZnJvbSBcImF3cy1zZGtcIlxuXG5pbXBvcnQgKiBhcyBUeXBlc2NyaXB0IGZyb20gXCJ0eXBlc2NyaXB0XCJcbmltcG9ydCAqIGFzIEdsb2IgZnJvbSBcImdsb2JieVwiXG5pbXBvcnQgKiBhcyBGUyBmcm9tIFwiZnMtZXh0cmFcIlxuaW1wb3J0ICogYXMgUGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgKiBhcyBBcmNoaXZlciBmcm9tIFwiYXJjaGl2ZXJcIlxuXG5leHBvcnQgdHlwZSBCdW5kbGVDb25maWcgPSB7XG4gICAgbmFtZXNwYWNlOiBzdHJpbmcsXG4gICAgYnVpbGREaXI6IHN0cmluZ1xuICAgIHNvdXJjZURpcjogc3RyaW5nLFxuICAgIHJlZ2lvbjogc3RyaW5nXG59XG5cbmV4cG9ydCBjb25zdCB1cGxvYWRGdW5jdGlvbiA9ICggY29uZmlnOiBCdW5kbGVDb25maWcgKSA9PiBmdW5jdGlvbiAoIHNlcnZpY2VzOiBzdHJpbmdbXSApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgczMgPSBuZXcgUzMoIHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0gKVxuICAgICAgICBjb25zdCBidW5kbGVfbmFtZSA9IGAkeyBjb25maWcubmFtZXNwYWNlIH0tLSR7IG1vZHVsZV9uYW1lIH1gXG5cbiAgICAgICAgY29uc29sZS5sb2coIFwidXBsb2FkaW5nXCIsIGJ1bmRsZV9uYW1lLCBcInRvXCIsIGAke2NvbmZpZy5uYW1lc3BhY2V9YCApXG5cbiAgICAgICAgRlMucmVhZEZpbGUoIGAkeyBjb25maWcuYnVpbGREaXIgfS8keyBidW5kbGVfbmFtZSB9LnppcGAgKVxuICAgICAgICAgICAgLnRoZW4oIGZ1bmN0aW9uICggYnVmZmVyICkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6IGJ1ZmZlcixcbiAgICAgICAgICAgICAgICAgICAgQnVja2V0OiBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LWFydGlmYWN0c2AsXG4gICAgICAgICAgICAgICAgICAgIEtleTogYCR7IGJ1bmRsZV9uYW1lIH0uemlwYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gKS50aGVuKCBwdXRfY29uZmlnID0+IHMzLnB1dE9iamVjdCggcHV0X2NvbmZpZyApLnByb21pc2UoKSApXG4gICAgICAgICAgICAudGhlbiggKCkgPT4gc2VydmljZV9maWxlIClcbiAgICB9ICkgKVxufVxuXG5leHBvcnQgY29uc3QgdXBkYXRlRnVuY3Rpb24gPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBtb2R1bGVfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG4gICAgICAgIGNvbnN0IGxhbWJkYSA9IG5ldyBMYW1iZGEoIHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0gKVxuICAgICAgICBjb25zdCBmdW5jdGlvbl9uYW1lID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgbW9kdWxlX25hbWUgfWBcblxuICAgICAgICBjb25zdCB1cGRhdGVfY29uZmlnID0ge1xuICAgICAgICAgICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbl9uYW1lLFxuICAgICAgICAgICAgUzNCdWNrZXQ6IGAkeyBjb25maWcubmFtZXNwYWNlIH0tYXJ0aWZhY3RzYCxcbiAgICAgICAgICAgIFMzS2V5OiBgJHsgZnVuY3Rpb25fbmFtZSB9LnppcGBcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKCBcInVwZGF0aW5nXCIsIGZ1bmN0aW9uX25hbWUsIFwiZnJvbVwiLCBjb25maWcubmFtZXNwYWNlIClcblxuICAgICAgICByZXR1cm4gbGFtYmRhLnVwZGF0ZUZ1bmN0aW9uQ29kZSggdXBkYXRlX2NvbmZpZyApLnByb21pc2UoKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBwdWJsaXNoRnVuY3Rpb24gPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBtb2R1bGVfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG5cbiAgICAgICAgY29uc3QgbGFtYmRhID0gbmV3IExhbWJkYSggeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSApXG4gICAgICAgIGNvbnN0IGZ1bmN0aW9uX25hbWUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBtb2R1bGVfbmFtZSB9YFxuXG4gICAgICAgIGNvbnN0IHVwZGF0ZV9jb25maWcgPSB7XG4gICAgICAgICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uX25hbWVcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKCBcInB1Ymxpc2hpbmdcIiwgZnVuY3Rpb25fbmFtZSwgY29uZmlnLm5hbWVzcGFjZSApXG5cbiAgICAgICAgcmV0dXJuIGxhbWJkYS5wdWJsaXNoVmVyc2lvbiggdXBkYXRlX2NvbmZpZyApLnByb21pc2UoKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBkZXRlY3QgPSBmdW5jdGlvbiAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gR2xvYiggUGF0aC5qb2luKCBjb25maWcuc291cmNlRGlyLCBcIioudHNcIiApIClcbn1cblxuZXhwb3J0IGNvbnN0IGNvbXBpbGUgPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IHNlcnZpY2VfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG5cbiAgICAgICAgY29uc3QgY29tcGlsZV9vcHRpb25zID0ge1xuICAgICAgICAgICAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgICAgICAgICAgIG5vSW1wbGljaXRBbnk6IGZhbHNlLFxuICAgICAgICAgICAgdGFyZ2V0OiBUeXBlc2NyaXB0LlNjcmlwdFRhcmdldC5FUzIwMTUsXG4gICAgICAgICAgICBtb2R1bGU6IFR5cGVzY3JpcHQuTW9kdWxlS2luZC5Db21tb25KUyxcbiAgICAgICAgICAgIG1vZHVsZVJlc29sdXRpb246IFR5cGVzY3JpcHQuTW9kdWxlUmVzb2x1dGlvbktpbmQuTm9kZUpzLFxuICAgICAgICAgICAgaW5saW5lU291cmNlTWFwOiBmYWxzZSxcbiAgICAgICAgICAgIGlubGluZVNvdXJjZXM6IGZhbHNlLFxuICAgICAgICAgICAgb3V0RGlyOiBQYXRoLmpvaW4oIGNvbmZpZy5idWlsZERpciwgc2VydmljZV9uYW1lIClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb2dyYW0gPSBUeXBlc2NyaXB0LmNyZWF0ZVByb2dyYW0oIFsgc2VydmljZV9maWxlIF0sIGNvbXBpbGVfb3B0aW9ucyApXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IGVtaXRSZXN1bHQgPSBwcm9ncmFtLmVtaXQoKVxuXG4gICAgICAgICAgICBjb25zdCBhbGxEaWFnbm9zdGljcyA9IFR5cGVzY3JpcHQuZ2V0UHJlRW1pdERpYWdub3N0aWNzKCBwcm9ncmFtIClcbiAgICAgICAgICAgICAgICAuY29uY2F0KCBlbWl0UmVzdWx0LmRpYWdub3N0aWNzIClcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IGFsbERpYWdub3N0aWNzLm1hcCggZnVuY3Rpb24gKCBkaWFnbm9zdGljICkge1xuICAgICAgICAgICAgICAgIGlmICggZGlhZ25vc3RpYy5maWxlICkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgeyBsaW5lLCBjaGFyYWN0ZXIgfSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFnbm9zdGljLmZpbGUuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24oIGRpYWdub3N0aWMuc3RhcnQgKVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID1cbiAgICAgICAgICAgICAgICAgICAgICAgIFR5cGVzY3JpcHQuZmxhdHRlbkRpYWdub3N0aWNNZXNzYWdlVGV4dCggZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCwgJ1xcbicgKVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtkaWFnbm9zdGljLmZpbGUuZmlsZU5hbWV9ICgke2xpbmUgKyAxfSwke2NoYXJhY3RlciArIDF9KTogJHttZXNzYWdlfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtUeXBlc2NyaXB0LmZsYXR0ZW5EaWFnbm9zdGljTWVzc2FnZVRleHQoIGRpYWdub3N0aWMubWVzc2FnZVRleHQsICdcXG4nICl9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICByZXN1bHRzLmxlbmd0aCA+IDAgPyByZWplY3QoIHJlc3VsdHMgKSA6IHJlc29sdmUoIHNlcnZpY2VfZmlsZSApXG4gICAgICAgIH0gKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBidW5kbGUgPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZSA9IEFyY2hpdmVyKCBcInppcFwiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZV9maWxlID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgYnVuZGxlX25hbWUgfS56aXBgXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IEZTLmNyZWF0ZVdyaXRlU3RyZWFtKFxuICAgICAgICAgICAgICAgIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBhcmNoaXZlX2ZpbGUgKSApXG5cbiAgICAgICAgICAgIGFyY2hpdmUub24oIFwiZXJyb3JcIiwgZnVuY3Rpb24gKCBlcnIgKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCBlcnIgKVxuICAgICAgICAgICAgfSApXG5cbiAgICAgICAgICAgIG91dHB1dC5vbiggXCJjbG9zZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSggc2VydmljZV9maWxlIClcbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICBhcmNoaXZlLmRpcmVjdG9yeSggUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIGJ1bmRsZV9uYW1lICksIGNvbmZpZy5uYW1lc3BhY2UgKVxuXG4gICAgICAgICAgICBhcmNoaXZlLnBpcGUoIG91dHB1dCApXG4gICAgICAgICAgICBhcmNoaXZlLmZpbmFsaXplKClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuXG5cblxuIl19