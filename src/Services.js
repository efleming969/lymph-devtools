"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const Typescript = require("typescript");
const Glob = require("globby");
const FS = require("fs-extra");
const Path = require("path");
const Archiver = require("archiver");
const Webpack = require("webpack");
exports.uploadFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const s3 = new aws_sdk_1.S3({ region: config.region });
        const bundle_name = `${config.namespace}--${module_name}`;
        console.log("uploading", bundle_name, "to", `${config.namespace}`);
        FS.readFile(`${config.buildDir}/${bundle_name}.zip`)
            .then(function (buffer) {
            return {
                Body: buffer,
                Bucket: `${config.namespace}-artifacts`,
                Key: `${bundle_name}.zip`
            };
        }).then(put_config => s3.putObject(put_config).promise())
            .then(() => service_file);
    }));
};
exports.updateFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name,
            S3Bucket: `${config.namespace}-artifacts`,
            S3Key: `${function_name}.zip`
        };
        console.log("updating", function_name, "from", config.namespace);
        return lambda.updateFunctionCode(update_config).promise();
    }));
};
exports.publishFunction = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name
        };
        console.log("publishing", function_name, config.namespace);
        return lambda.publishVersion(update_config).promise();
    }));
};
exports.detect = function (config) {
    return Glob(Path.join(config.sourceDir, "*.ts"));
};
exports.compile = (config) => function (services) {
    const compile_options = {
        noEmitOnError: true,
        noImplicitAny: false,
        target: Typescript.ScriptTarget.ES2015,
        module: Typescript.ModuleKind.CommonJS,
        moduleResolution: Typescript.ModuleResolutionKind.NodeJs,
        outDir: Path.join(config.buildDir, "pre")
    };
    const program = Typescript.createProgram(services, compile_options);
    return new Promise(function (resolve, reject) {
        const emitResult = program.emit();
        const allDiagnostics = Typescript.getPreEmitDiagnostics(program)
            .concat(emitResult.diagnostics);
        const results = allDiagnostics.map(function (diagnostic) {
            if (diagnostic.file) {
                let { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                let message = Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                return `${diagnostic.file.fileName} (${line + 1},${character + 1}): ${message}`;
            }
            else {
                return `${Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n')}`;
            }
        });
        results.length > 0 ? reject(results) : resolve(services);
    });
};
exports.bundle = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const options = {
            entry: Path.join(process.cwd(), config.buildDir, "pre", `${module_name}.js`),
            mode: "production",
            output: {
                path: Path.join(process.cwd(), config.buildDir),
                libraryTarget: "commonjs",
                filename: `${module_name}.js`
            },
            target: "node",
            externals: ["aws-sdk"]
        };
        return new Promise(function (resolve, reject) {
            Webpack(options, function (err, stats) {
                if (err)
                    reject(err);
                if (stats.hasErrors()) {
                    reject(stats.toString());
                }
                resolve(service_file);
            });
        });
    }));
};
exports.archive = (config) => function (services) {
    return Promise.all(services.map(function (service_file) {
        const bundle_name = Path.basename(service_file, ".ts");
        const archive = Archiver("zip");
        const archive_file = `${config.namespace}--${bundle_name}.zip`;
        return new Promise(function (resolve, reject) {
            const output = FS.createWriteStream(Path.join(config.buildDir, archive_file));
            archive.on("error", function (err) {
                reject(err);
            });
            output.on("close", function () {
                resolve(service_file);
            });
            archive.file(Path.join(config.buildDir, `${bundle_name}.js`), { name: "index.js" });
            archive.pipe(output);
            archive.finalize();
        });
    }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvQztBQUVwQyx5Q0FBd0M7QUFDeEMsK0JBQThCO0FBQzlCLCtCQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIscUNBQW9DO0FBQ3BDLG1DQUFrQztBQVNyQixRQUFBLGNBQWMsR0FBRyxDQUFFLE1BQW9CLEVBQUcsRUFBRSxDQUFDLFVBQVcsUUFBa0I7SUFDbkYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBRSxVQUFXLFlBQVk7UUFDckQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBRSxZQUFZLEVBQUUsS0FBSyxDQUFFLENBQUE7UUFDeEQsTUFBTSxFQUFFLEdBQUcsSUFBSSxZQUFFLENBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFFLENBQUE7UUFDOUMsTUFBTSxXQUFXLEdBQUcsR0FBSSxNQUFNLENBQUMsU0FBVSxLQUFNLFdBQVksRUFBRSxDQUFBO1FBRTdELE9BQU8sQ0FBQyxHQUFHLENBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUUsQ0FBQTtRQUVwRSxFQUFFLENBQUMsUUFBUSxDQUFFLEdBQUksTUFBTSxDQUFDLFFBQVMsSUFBSyxXQUFZLE1BQU0sQ0FBRTthQUNyRCxJQUFJLENBQUUsVUFBVyxNQUFNO1lBQ3BCLE1BQU0sQ0FBQztnQkFDSCxJQUFJLEVBQUUsTUFBTTtnQkFDWixNQUFNLEVBQUUsR0FBSSxNQUFNLENBQUMsU0FBVSxZQUFZO2dCQUN6QyxHQUFHLEVBQUUsR0FBSSxXQUFZLE1BQU07YUFDOUIsQ0FBQTtRQUNMLENBQUMsQ0FBRSxDQUFDLElBQUksQ0FBRSxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUUsVUFB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LENBQUUsQ0FBQTtJQUNQLENBQUMsQ0FBRSxDQUFFLENBQUE7QUFDVCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMYW1iZGEsIFMzIH0gZnJvbSBcImF3cy1zZGtcIlxuXG5pbXBvcnQgKiBhcyBUeXBlc2NyaXB0IGZyb20gXCJ0eXBlc2NyaXB0XCJcbmltcG9ydCAqIGFzIEdsb2IgZnJvbSBcImdsb2JieVwiXG5pbXBvcnQgKiBhcyBGUyBmcm9tIFwiZnMtZXh0cmFcIlxuaW1wb3J0ICogYXMgUGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgKiBhcyBBcmNoaXZlciBmcm9tIFwiYXJjaGl2ZXJcIlxuaW1wb3J0ICogYXMgV2VicGFjayBmcm9tIFwid2VicGFja1wiXG5cbmV4cG9ydCB0eXBlIEJ1bmRsZUNvbmZpZyA9IHtcbiAgICBuYW1lc3BhY2U6IHN0cmluZyxcbiAgICBidWlsZERpcjogc3RyaW5nXG4gICAgc291cmNlRGlyOiBzdHJpbmcsXG4gICAgcmVnaW9uOiBzdHJpbmdcbn1cblxuZXhwb3J0IGNvbnN0IHVwbG9hZEZ1bmN0aW9uID0gKCBjb25maWc6IEJ1bmRsZUNvbmZpZyApID0+IGZ1bmN0aW9uICggc2VydmljZXM6IHN0cmluZ1tdICkge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCggc2VydmljZXMubWFwKCBmdW5jdGlvbiAoIHNlcnZpY2VfZmlsZSApIHtcbiAgICAgICAgY29uc3QgbW9kdWxlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuICAgICAgICBjb25zdCBzMyA9IG5ldyBTMyggeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSApXG4gICAgICAgIGNvbnN0IGJ1bmRsZV9uYW1lID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgbW9kdWxlX25hbWUgfWBcblxuICAgICAgICBjb25zb2xlLmxvZyggXCJ1cGxvYWRpbmdcIiwgYnVuZGxlX25hbWUsIFwidG9cIiwgYCR7Y29uZmlnLm5hbWVzcGFjZX1gIClcblxuICAgICAgICBGUy5yZWFkRmlsZSggYCR7IGNvbmZpZy5idWlsZERpciB9LyR7IGJ1bmRsZV9uYW1lIH0uemlwYCApXG4gICAgICAgICAgICAudGhlbiggZnVuY3Rpb24gKCBidWZmZXIgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgQm9keTogYnVmZmVyLFxuICAgICAgICAgICAgICAgICAgICBCdWNrZXQ6IGAkeyBjb25maWcubmFtZXNwYWNlIH0tYXJ0aWZhY3RzYCxcbiAgICAgICAgICAgICAgICAgICAgS2V5OiBgJHsgYnVuZGxlX25hbWUgfS56aXBgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSApLnRoZW4oIHB1dF9jb25maWcgPT4gczMucHV0T2JqZWN0KCBwdXRfY29uZmlnICkucHJvbWlzZSgpIClcbiAgICAgICAgICAgIC50aGVuKCAoKSA9PiBzZXJ2aWNlX2ZpbGUgKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVGdW5jdGlvbiA9ICggY29uZmlnOiBCdW5kbGVDb25maWcgKSA9PiBmdW5jdGlvbiAoIHNlcnZpY2VzOiBzdHJpbmdbXSApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgbGFtYmRhID0gbmV3IExhbWJkYSggeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSApXG4gICAgICAgIGNvbnN0IGZ1bmN0aW9uX25hbWUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBtb2R1bGVfbmFtZSB9YFxuXG4gICAgICAgIGNvbnN0IHVwZGF0ZV9jb25maWcgPSB7XG4gICAgICAgICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uX25hbWUsXG4gICAgICAgICAgICBTM0J1Y2tldDogYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS1hcnRpZmFjdHNgLFxuICAgICAgICAgICAgUzNLZXk6IGAkeyBmdW5jdGlvbl9uYW1lIH0uemlwYFxuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coIFwidXBkYXRpbmdcIiwgZnVuY3Rpb25fbmFtZSwgXCJmcm9tXCIsIGNvbmZpZy5uYW1lc3BhY2UgKVxuXG4gICAgICAgIHJldHVybiBsYW1iZGEudXBkYXRlRnVuY3Rpb25Db2RlKCB1cGRhdGVfY29uZmlnICkucHJvbWlzZSgpXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IHB1Ymxpc2hGdW5jdGlvbiA9ICggY29uZmlnOiBCdW5kbGVDb25maWcgKSA9PiBmdW5jdGlvbiAoIHNlcnZpY2VzOiBzdHJpbmdbXSApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcblxuICAgICAgICBjb25zdCBsYW1iZGEgPSBuZXcgTGFtYmRhKCB7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9IClcbiAgICAgICAgY29uc3QgZnVuY3Rpb25fbmFtZSA9IGAkeyBjb25maWcubmFtZXNwYWNlIH0tLSR7IG1vZHVsZV9uYW1lIH1gXG5cbiAgICAgICAgY29uc3QgdXBkYXRlX2NvbmZpZyA9IHtcbiAgICAgICAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25fbmFtZVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coIFwicHVibGlzaGluZ1wiLCBmdW5jdGlvbl9uYW1lLCBjb25maWcubmFtZXNwYWNlIClcblxuICAgICAgICByZXR1cm4gbGFtYmRhLnB1Ymxpc2hWZXJzaW9uKCB1cGRhdGVfY29uZmlnICkucHJvbWlzZSgpXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IGRldGVjdCA9IGZ1bmN0aW9uICggY29uZmlnOiBCdW5kbGVDb25maWcgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiBHbG9iKCBQYXRoLmpvaW4oIGNvbmZpZy5zb3VyY2VEaXIsIFwiKi50c1wiICkgKVxufVxuXG5leHBvcnQgY29uc3QgY29tcGlsZSA9ICggY29uZmlnOiBCdW5kbGVDb25maWcgKSA9PiBmdW5jdGlvbiAoIHNlcnZpY2VzOiBzdHJpbmdbXSApOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGNvbXBpbGVfb3B0aW9ucyA9IHtcbiAgICAgICAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgICAgICAgbm9JbXBsaWNpdEFueTogZmFsc2UsXG4gICAgICAgIHRhcmdldDogVHlwZXNjcmlwdC5TY3JpcHRUYXJnZXQuRVMyMDE1LFxuICAgICAgICBtb2R1bGU6IFR5cGVzY3JpcHQuTW9kdWxlS2luZC5Db21tb25KUyxcbiAgICAgICAgbW9kdWxlUmVzb2x1dGlvbjogVHlwZXNjcmlwdC5Nb2R1bGVSZXNvbHV0aW9uS2luZC5Ob2RlSnMsXG4gICAgICAgIG91dERpcjogUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIFwicHJlXCIgKVxuICAgIH1cblxuICAgIGNvbnN0IHByb2dyYW0gPSBUeXBlc2NyaXB0LmNyZWF0ZVByb2dyYW0oIHNlcnZpY2VzLCBjb21waWxlX29wdGlvbnMgKVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgY29uc3QgZW1pdFJlc3VsdCA9IHByb2dyYW0uZW1pdCgpXG5cbiAgICAgICAgY29uc3QgYWxsRGlhZ25vc3RpY3MgPSBUeXBlc2NyaXB0LmdldFByZUVtaXREaWFnbm9zdGljcyggcHJvZ3JhbSApXG4gICAgICAgICAgICAuY29uY2F0KCBlbWl0UmVzdWx0LmRpYWdub3N0aWNzIClcblxuICAgICAgICBjb25zdCByZXN1bHRzID0gYWxsRGlhZ25vc3RpY3MubWFwKCBmdW5jdGlvbiAoIGRpYWdub3N0aWMgKSB7XG4gICAgICAgICAgICBpZiAoIGRpYWdub3N0aWMuZmlsZSApIHtcbiAgICAgICAgICAgICAgICBsZXQgeyBsaW5lLCBjaGFyYWN0ZXIgfSA9XG4gICAgICAgICAgICAgICAgICAgIGRpYWdub3N0aWMuZmlsZS5nZXRMaW5lQW5kQ2hhcmFjdGVyT2ZQb3NpdGlvbiggZGlhZ25vc3RpYy5zdGFydCApXG5cbiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9XG4gICAgICAgICAgICAgICAgICAgIFR5cGVzY3JpcHQuZmxhdHRlbkRpYWdub3N0aWNNZXNzYWdlVGV4dCggZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCwgJ1xcbicgKVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke2RpYWdub3N0aWMuZmlsZS5maWxlTmFtZX0gKCR7bGluZSArIDF9LCR7Y2hhcmFjdGVyICsgMX0pOiAke21lc3NhZ2V9YFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke1R5cGVzY3JpcHQuZmxhdHRlbkRpYWdub3N0aWNNZXNzYWdlVGV4dCggZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCwgJ1xcbicgKX1gXG4gICAgICAgICAgICB9XG4gICAgICAgIH0gKVxuXG4gICAgICAgIHJlc3VsdHMubGVuZ3RoID4gMCA/IHJlamVjdCggcmVzdWx0cyApIDogcmVzb2x2ZSggc2VydmljZXMgKVxuICAgIH0gKVxufVxuXG5leHBvcnQgY29uc3QgYnVuZGxlID0gKCBjb25maWc6IEJ1bmRsZUNvbmZpZyApID0+IGZ1bmN0aW9uICggc2VydmljZXM6IHN0cmluZ1tdICk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBtb2R1bGVfbmFtZSA9IFBhdGguYmFzZW5hbWUoIHNlcnZpY2VfZmlsZSwgXCIudHNcIiApXG5cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIGVudHJ5OiBQYXRoLmpvaW4oIHByb2Nlc3MuY3dkKCksIGNvbmZpZy5idWlsZERpciwgXCJwcmVcIiwgYCR7IG1vZHVsZV9uYW1lIH0uanNgICksXG4gICAgICAgICAgICBtb2RlOiBcInByb2R1Y3Rpb25cIixcbiAgICAgICAgICAgIG91dHB1dDoge1xuICAgICAgICAgICAgICAgIHBhdGg6IFBhdGguam9pbiggcHJvY2Vzcy5jd2QoKSwgY29uZmlnLmJ1aWxkRGlyICksXG4gICAgICAgICAgICAgICAgbGlicmFyeVRhcmdldDogXCJjb21tb25qc1wiLFxuICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBgJHsgbW9kdWxlX25hbWUgfS5qc2BcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0YXJnZXQ6IFwibm9kZVwiLFxuICAgICAgICAgICAgZXh0ZXJuYWxzOiBbIFwiYXdzLXNka1wiIF1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSggZnVuY3Rpb24gKCByZXNvbHZlLCByZWplY3QgKSB7XG4gICAgICAgICAgICBXZWJwYWNrKCBvcHRpb25zLCBmdW5jdGlvbiAoIGVyciwgc3RhdHMgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCBlcnIgKSByZWplY3QoIGVyciApXG5cbiAgICAgICAgICAgICAgICBpZiAoIHN0YXRzLmhhc0Vycm9ycygpICkge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoIHN0YXRzLnRvU3RyaW5nKCkgKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlc29sdmUoIHNlcnZpY2VfZmlsZSApXG4gICAgICAgICAgICB9IClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IGFyY2hpdmUgPSAoIGNvbmZpZzogQnVuZGxlQ29uZmlnICkgPT4gZnVuY3Rpb24gKCBzZXJ2aWNlczogc3RyaW5nW10gKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZSA9IEFyY2hpdmVyKCBcInppcFwiIClcbiAgICAgICAgY29uc3QgYXJjaGl2ZV9maWxlID0gYCR7IGNvbmZpZy5uYW1lc3BhY2UgfS0tJHsgYnVuZGxlX25hbWUgfS56aXBgXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IEZTLmNyZWF0ZVdyaXRlU3RyZWFtKFxuICAgICAgICAgICAgICAgIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBhcmNoaXZlX2ZpbGUgKSApXG5cbiAgICAgICAgICAgIGFyY2hpdmUub24oIFwiZXJyb3JcIiwgZnVuY3Rpb24gKCBlcnIgKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCBlcnIgKVxuICAgICAgICAgICAgfSApXG5cbiAgICAgICAgICAgIG91dHB1dC5vbiggXCJjbG9zZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSggc2VydmljZV9maWxlIClcbiAgICAgICAgICAgIH0gKVxuXG4gICAgICAgICAgICBhcmNoaXZlLmZpbGUoIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBgJHsgYnVuZGxlX25hbWUgfS5qc2AgKSwgeyBuYW1lOiBcImluZGV4LmpzXCIgfSApXG5cbiAgICAgICAgICAgIGFyY2hpdmUucGlwZSggb3V0cHV0IClcbiAgICAgICAgICAgIGFyY2hpdmUuZmluYWxpemUoKVxuICAgICAgICB9IClcbiAgICB9ICkgKVxufVxuXG5cblxuXG4iXX0=