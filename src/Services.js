"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const Typescript = require("typescript");
const Glob = require("globby");
const FS = require("fs-extra");
const Path = require("path");
const Archiver = require("archiver");
exports.uploadFunction = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const s3 = new aws_sdk_1.S3({ region: config.region });
        const bundle_name = `${config.namespace}--${module_name}`;
        console.log("uploading", bundle_name, "to", `${config.namespace}`);
        FS.readFile(`${config.buildDir}/${bundle_name}.zip`)
            .then(function (buffer) {
            return {
                Body: buffer,
                Bucket: `${config.namespace}-artifacts`,
                Key: `${bundle_name}.zip`
            };
        }).then(put_config => s3.putObject(put_config).promise());
    }));
};
exports.updateFunction = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const module_name = Path.basename(service_file, ".ts");
        const lambda = new aws_sdk_1.Lambda({ region: config.region });
        const function_name = `${config.namespace}--${module_name}`;
        const update_config = {
            FunctionName: function_name,
            S3Bucket: `${config.namespace}-artifacts`,
            S3Key: `${function_name}.zip`
        };
        console.log("updating", function_name, "from", config.namespace);
        return lambda.updateFunctionCode(update_config).promise();
    }));
};
exports.detect = function (config) {
    return Glob(Path.join(config.sourceDir, "*.ts"));
};
exports.compile = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const service_name = Path.basename(service_file, ".ts");
        const compile_options = {
            noEmitOnError: true,
            noImplicitAny: false,
            target: Typescript.ScriptTarget.ES2015,
            module: Typescript.ModuleKind.CommonJS,
            moduleResolution: Typescript.ModuleResolutionKind.NodeJs,
            inlineSourceMap: false,
            inlineSources: false,
            outDir: Path.join(config.buildDir, service_name)
        };
        const program = Typescript.createProgram([service_file], compile_options);
        return new Promise(function (resolve, reject) {
            const emitResult = program.emit();
            const allDiagnostics = Typescript.getPreEmitDiagnostics(program)
                .concat(emitResult.diagnostics);
            const results = allDiagnostics.map(function (diagnostic) {
                if (diagnostic.file) {
                    let { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                    let message = Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                    return `${diagnostic.file.fileName} (${line + 1},${character + 1}): ${message}`;
                }
                else {
                    return `${Typescript.flattenDiagnosticMessageText(diagnostic.messageText, '\n')}`;
                }
            });
            results.length > 0 ? reject(results) : resolve();
        });
    }));
};
exports.bundle = function (config, services) {
    return Promise.all(services.map(function (service_file) {
        const bundle_name = Path.basename(service_file, ".ts");
        const archive = Archiver("zip");
        const archive_file = `${config.namespace}--${bundle_name}.zip`;
        return new Promise(function (resolve, reject) {
            const output = FS.createWriteStream(Path.join(config.buildDir, archive_file));
            archive.on("error", function (err) {
                reject(err);
            });
            output.on("close", function () {
                resolve(bundle_name);
            });
            archive.directory(Path.join(config.buildDir, bundle_name), config.namespace);
            archive.pipe(output);
            archive.finalize();
        });
    }));
};
exports.build = function (config) {
    return exports.detect(config)
        .then(output => console.dir(output))
        .catch(e => console.log(e));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFvQztBQUVwQyx5Q0FBd0M7QUFDeEMsK0JBQThCO0FBQzlCLCtCQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIscUNBQW9DO0FBU3ZCLFFBQUEsY0FBYyxHQUFHLFVBQVcsTUFBb0IsRUFBRSxRQUFrQjtJQUM3RSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxRQUFRLENBQUMsR0FBRyxDQUFFLFVBQVcsWUFBWTtRQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFFLFlBQVksRUFBRSxLQUFLLENBQUUsQ0FBQTtRQUN4RCxNQUFNLEVBQUUsR0FBRyxJQUFJLFlBQUUsQ0FBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtRQUM5QyxNQUFNLFdBQVcsR0FBRyxHQUFJLE1BQU0sQ0FBQyxTQUFVLEtBQU0sV0FBWSxFQUFFLENBQUE7UUFFN0QsT0FBTyxDQUFDLEdBQUcsQ0FBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBRSxDQUFBO1FBRXBFLEVBQUUsQ0FBQyxRQUFRLENBQUUsR0FBSSxNQUFNLENBQUMsUUFBUyxJQUFLLFdBQVksTUFBTSxDQUFFO2FBQ3JELElBQUksQ0FBRSxVQUFXLE1BQU07WUFDcEIsTUFBTSxDQUFDO2dCQUNILElBQUksRUFBRSxNQUFNO2dCQUNaLE1BQU0sRUFBRSxHQUFJLE1BQU0sQ0FBQyxTQUFVLFlBQVk7Z0JBQ3pDLEdBQUcsRUFBRSxHQUFJLFdBQVksTUFBTTthQUM5QixDQUFBO1FBQ0wsQ0FBQyxDQUFFLENBQUMsSUFBSSxDQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBRSxVQUFVLENBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBRSxD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QUFDLEVBQUUsQ0FBRSxPQUFPLEVBQUUsVUFBVyxHQUFHO2dCQUMvQixNQUFNLENBQUUsR0FBRyxDQUFFLENBQUE7WUFDakIsQ0FBQyxDQUFFLENBQUE7WUFFSCxNQUFNLENBQUMsRUFBRSxDQUFFLE9BQU8sRUFBRTtnQkFDaEIsT0FBTyxDQUFFLFdBQVcsQ0FBRSxDQUFBO1lBQzFCLENBQUMsQ0FBRSxDQUFBO1lBRUgsT0FBTyxDQUFDLFNBQVMsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFFLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBRSxDQUFBO1lBRWhGLE9BQU8sQ0FBQyxJQUFJLENBQUUsTUFBTSxDQUFFLENBQUE7WUFDdEIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQ3RCLENBQUMsQ0FBRSxDQUFBO0lBQ1AsQ0FBQyxDQUFFLENBQUUsQ0FBQTtBQUNULENBQUMsQ0FBQTtBQUVZLFFBQUEsS0FBSyxHQUFHLFVBQVcsTUFBTTtJQUNsQyxNQUFNLENBQUMsY0FBTSxDQUFFLE1BQU0sQ0FBRTtTQUlsQixJQUFJLENBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFFLE1BQU0sQ0FBRSxDQUFFO1NBQ3ZDLEtBQUssQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFFLENBQUUsQ0FBQTtBQUN2QyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMYW1iZGEsIFMzIH0gZnJvbSBcImF3cy1zZGtcIlxuXG5pbXBvcnQgKiBhcyBUeXBlc2NyaXB0IGZyb20gXCJ0eXBlc2NyaXB0XCJcbmltcG9ydCAqIGFzIEdsb2IgZnJvbSBcImdsb2JieVwiXG5pbXBvcnQgKiBhcyBGUyBmcm9tIFwiZnMtZXh0cmFcIlxuaW1wb3J0ICogYXMgUGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgKiBhcyBBcmNoaXZlciBmcm9tIFwiYXJjaGl2ZXJcIlxuXG5leHBvcnQgdHlwZSBCdW5kbGVDb25maWcgPSB7XG4gICAgbmFtZXNwYWNlOiBzdHJpbmcsXG4gICAgYnVpbGREaXI6IHN0cmluZ1xuICAgIHNvdXJjZURpcjogc3RyaW5nLFxuICAgIHJlZ2lvbjogc3RyaW5nXG59XG5cbmV4cG9ydCBjb25zdCB1cGxvYWRGdW5jdGlvbiA9IGZ1bmN0aW9uICggY29uZmlnOiBCdW5kbGVDb25maWcsIHNlcnZpY2VzOiBzdHJpbmdbXSApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoIHNlcnZpY2VzLm1hcCggZnVuY3Rpb24gKCBzZXJ2aWNlX2ZpbGUgKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZV9uYW1lID0gUGF0aC5iYXNlbmFtZSggc2VydmljZV9maWxlLCBcIi50c1wiIClcbiAgICAgICAgY29uc3QgczMgPSBuZXcgUzMoIHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0gKVxuICAgICAgICBjb25zdCBidW5kbGVfbmFtZSA9IGAkeyBjb25maWcubmFtZXNwYWNlIH0tLSR7IG1vZHVsZV9uYW1lIH1gXG5cbiAgICAgICAgY29uc29sZS5sb2coIFwidXBsb2FkaW5nXCIsIGJ1bmRsZV9uYW1lLCBcInRvXCIsIGAke2NvbmZpZy5uYW1lc3BhY2V9YCApXG5cbiAgICAgICAgRlMucmVhZEZpbGUoIGAkeyBjb25maWcuYnVpbGREaXIgfS8keyBidW5kbGVfbmFtZSB9LnppcGAgKVxuICAgICAgICAgICAgLnRoZW4oIGZ1bmN0aW9uICggYnVmZmVyICkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIEJvZHk6IGJ1ZmZlcixcbiAgICAgICAgICAgICAgICAgICAgQnVja2V0OiBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LWFydGlmYWN0c2AsXG4gICAgICAgICAgICAgICAgICAgIEtleTogYCR7IGJ1bmRsZV9uYW1lIH0uemlwYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gKS50aGVuKCBwdXRfY29uZmlnID0+IHMzLnB1dE9iamVjdCggcHV0X2NvbmZpZyApLnByb21pc2UoKSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IHVwZGF0ZUZ1bmN0aW9uID0gZnVuY3Rpb24gKCBjb25maWc6IEJ1bmRsZUNvbmZpZywgc2VydmljZXM6IHN0cmluZ1tdICkge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCggc2VydmljZXMubWFwKCBmdW5jdGlvbiAoIHNlcnZpY2VfZmlsZSApIHtcbiAgICAgICAgY29uc3QgbW9kdWxlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuICAgICAgICBjb25zdCBsYW1iZGEgPSBuZXcgTGFtYmRhKCB7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9IClcbiAgICAgICAgY29uc3QgZnVuY3Rpb25fbmFtZSA9IGAkeyBjb25maWcubmFtZXNwYWNlIH0tLSR7IG1vZHVsZV9uYW1lIH1gXG5cbiAgICAgICAgY29uc3QgdXBkYXRlX2NvbmZpZyA9IHtcbiAgICAgICAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25fbmFtZSxcbiAgICAgICAgICAgIFMzQnVja2V0OiBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LWFydGlmYWN0c2AsXG4gICAgICAgICAgICBTM0tleTogYCR7IGZ1bmN0aW9uX25hbWUgfS56aXBgXG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZyggXCJ1cGRhdGluZ1wiLCBmdW5jdGlvbl9uYW1lLCBcImZyb21cIiwgY29uZmlnLm5hbWVzcGFjZSApXG5cbiAgICAgICAgcmV0dXJuIGxhbWJkYS51cGRhdGVGdW5jdGlvbkNvZGUoIHVwZGF0ZV9jb25maWcgKS5wcm9taXNlKClcbiAgICB9ICkgKVxufVxuXG5leHBvcnQgY29uc3QgZGV0ZWN0ID0gZnVuY3Rpb24gKCBjb25maWc6IEJ1bmRsZUNvbmZpZyApOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgcmV0dXJuIEdsb2IoIFBhdGguam9pbiggY29uZmlnLnNvdXJjZURpciwgXCIqLnRzXCIgKSApXG59XG5cbmV4cG9ydCBjb25zdCBjb21waWxlID0gZnVuY3Rpb24gKCBjb25maWc6IEJ1bmRsZUNvbmZpZywgc2VydmljZXM6IHN0cmluZ1tdICk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKCBzZXJ2aWNlcy5tYXAoIGZ1bmN0aW9uICggc2VydmljZV9maWxlICkge1xuICAgICAgICBjb25zdCBzZXJ2aWNlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuXG4gICAgICAgIGNvbnN0IGNvbXBpbGVfb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG5vRW1pdE9uRXJyb3I6IHRydWUsXG4gICAgICAgICAgICBub0ltcGxpY2l0QW55OiBmYWxzZSxcbiAgICAgICAgICAgIHRhcmdldDogVHlwZXNjcmlwdC5TY3JpcHRUYXJnZXQuRVMyMDE1LFxuICAgICAgICAgICAgbW9kdWxlOiBUeXBlc2NyaXB0Lk1vZHVsZUtpbmQuQ29tbW9uSlMsXG4gICAgICAgICAgICBtb2R1bGVSZXNvbHV0aW9uOiBUeXBlc2NyaXB0Lk1vZHVsZVJlc29sdXRpb25LaW5kLk5vZGVKcyxcbiAgICAgICAgICAgIGlubGluZVNvdXJjZU1hcDogZmFsc2UsXG4gICAgICAgICAgICBpbmxpbmVTb3VyY2VzOiBmYWxzZSxcbiAgICAgICAgICAgIG91dERpcjogUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIHNlcnZpY2VfbmFtZSApXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcm9ncmFtID0gVHlwZXNjcmlwdC5jcmVhdGVQcm9ncmFtKCBbIHNlcnZpY2VfZmlsZSBdLCBjb21waWxlX29wdGlvbnMgKVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSggZnVuY3Rpb24gKCByZXNvbHZlLCByZWplY3QgKSB7XG4gICAgICAgICAgICBjb25zdCBlbWl0UmVzdWx0ID0gcHJvZ3JhbS5lbWl0KClcblxuICAgICAgICAgICAgY29uc3QgYWxsRGlhZ25vc3RpY3MgPSBUeXBlc2NyaXB0LmdldFByZUVtaXREaWFnbm9zdGljcyggcHJvZ3JhbSApXG4gICAgICAgICAgICAgICAgLmNvbmNhdCggZW1pdFJlc3VsdC5kaWFnbm9zdGljcyApXG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhbGxEaWFnbm9zdGljcy5tYXAoIGZ1bmN0aW9uICggZGlhZ25vc3RpYyApIHtcbiAgICAgICAgICAgICAgICBpZiAoIGRpYWdub3N0aWMuZmlsZSApIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHsgbGluZSwgY2hhcmFjdGVyIH0gPVxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhZ25vc3RpYy5maWxlLmdldExpbmVBbmRDaGFyYWN0ZXJPZlBvc2l0aW9uKCBkaWFnbm9zdGljLnN0YXJ0IClcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBUeXBlc2NyaXB0LmZsYXR0ZW5EaWFnbm9zdGljTWVzc2FnZVRleHQoIGRpYWdub3N0aWMubWVzc2FnZVRleHQsICdcXG4nIClcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7ZGlhZ25vc3RpYy5maWxlLmZpbGVOYW1lfSAoJHtsaW5lICsgMX0sJHtjaGFyYWN0ZXIgKyAxfSk6ICR7bWVzc2FnZX1gXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7VHlwZXNjcmlwdC5mbGF0dGVuRGlhZ25vc3RpY01lc3NhZ2VUZXh0KCBkaWFnbm9zdGljLm1lc3NhZ2VUZXh0LCAnXFxuJyApfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IClcblxuICAgICAgICAgICAgcmVzdWx0cy5sZW5ndGggPiAwID8gcmVqZWN0KCByZXN1bHRzICkgOiByZXNvbHZlKClcbiAgICAgICAgfSApXG4gICAgfSApIClcbn1cblxuZXhwb3J0IGNvbnN0IGJ1bmRsZSA9IGZ1bmN0aW9uICggY29uZmlnOiBCdW5kbGVDb25maWcsIHNlcnZpY2VzOiBzdHJpbmdbXSApOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbCggc2VydmljZXMubWFwKCBmdW5jdGlvbiAoIHNlcnZpY2VfZmlsZSApIHtcbiAgICAgICAgY29uc3QgYnVuZGxlX25hbWUgPSBQYXRoLmJhc2VuYW1lKCBzZXJ2aWNlX2ZpbGUsIFwiLnRzXCIgKVxuICAgICAgICBjb25zdCBhcmNoaXZlID0gQXJjaGl2ZXIoIFwiemlwXCIgKVxuICAgICAgICBjb25zdCBhcmNoaXZlX2ZpbGUgPSBgJHsgY29uZmlnLm5hbWVzcGFjZSB9LS0keyBidW5kbGVfbmFtZSB9LnppcGBcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoIGZ1bmN0aW9uICggcmVzb2x2ZSwgcmVqZWN0ICkge1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gRlMuY3JlYXRlV3JpdGVTdHJlYW0oXG4gICAgICAgICAgICAgICAgUGF0aC5qb2luKCBjb25maWcuYnVpbGREaXIsIGFyY2hpdmVfZmlsZSApIClcblxuICAgICAgICAgICAgYXJjaGl2ZS5vbiggXCJlcnJvclwiLCBmdW5jdGlvbiAoIGVyciApIHtcbiAgICAgICAgICAgICAgICByZWplY3QoIGVyciApXG4gICAgICAgICAgICB9IClcblxuICAgICAgICAgICAgb3V0cHV0Lm9uKCBcImNsb3NlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCBidW5kbGVfbmFtZSApXG4gICAgICAgICAgICB9IClcblxuICAgICAgICAgICAgYXJjaGl2ZS5kaXJlY3RvcnkoIFBhdGguam9pbiggY29uZmlnLmJ1aWxkRGlyLCBidW5kbGVfbmFtZSApLCBjb25maWcubmFtZXNwYWNlIClcblxuICAgICAgICAgICAgYXJjaGl2ZS5waXBlKCBvdXRwdXQgKVxuICAgICAgICAgICAgYXJjaGl2ZS5maW5hbGl6ZSgpXG4gICAgICAgIH0gKVxuICAgIH0gKSApXG59XG5cbmV4cG9ydCBjb25zdCBidWlsZCA9IGZ1bmN0aW9uICggY29uZmlnICkge1xuICAgIHJldHVybiBkZXRlY3QoIGNvbmZpZyApXG4gICAgLy8gLnRoZW4oIHByb21pc2VBbGwoIHppcE1vZHVsZSggY29uZmlnICkgKSApXG4gICAgLy8gLnRoZW4oIHByb21pc2VBbGwoIHVwbG9hZEZ1bmN0aW9uKCBjb25maWcgKSApIClcbiAgICAvLyAudGhlbiggcHJvbWlzZUFsbCggdXBkYXRlRnVuY3Rpb24oIGNvbmZpZyApICkgKVxuICAgICAgICAudGhlbiggb3V0cHV0ID0+IGNvbnNvbGUuZGlyKCBvdXRwdXQgKSApXG4gICAgICAgIC5jYXRjaCggZSA9PiBjb25zb2xlLmxvZyggZSApIClcbn1cblxuIl19