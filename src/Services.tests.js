"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Glob = require("globby");
const AWS = require("aws-sdk");
const Services = require("./Services");
const Utils_1 = require("./Utils");
const source_dir = "src/samples/services";
const bundle_config = {
    namespace: "lymph",
    buildDir: "build/services",
    sourceDir: source_dir,
    region: "us-east-1"
};
const services = [
    "src/samples/services/hello-commands.ts",
    "src/samples/services/hello-queries.ts"
];
afterAll(Utils_1.removeAllJSFiles(source_dir));
test("detecting services", function () {
    return Services.detect(bundle_config).then(function (detected_services) {
        expect(detected_services.sort()).toEqual(services);
    });
});
test("compiling services to separate build directories", function () {
    return Services.compile(bundle_config)(services).then(function () {
        return Glob(bundle_config.buildDir + "/**/*.js").then(function (files) {
            expect(files.sort()).toEqual([
                "build/services/hello-commands/common/Lambda.js",
                "build/services/hello-commands/hello-commands.js",
                "build/services/hello-queries/hello-queries.js",
            ]);
        });
    });
});
test("bundling services into zip files", function () {
    return Services.bundle(bundle_config)(services).then(function () {
        return Glob(bundle_config.buildDir + "/*.zip").then(function (files) {
            expect(files.sort()).toEqual([
                "build/services/lymph--hello-commands.zip",
                "build/services/lymph--hello-queries.zip",
            ]);
        });
    });
});
test("upload service bundles to s3", function () {
    const S3 = new AWS.S3({ region: bundle_config.region });
    const time_stamp = new Date().getTime() - 180000; // 2 minute buffer
    return Services.uploadFunction(bundle_config)(services).then(function () {
        const params = { Bucket: "lymph-artifacts" };
        return S3.listObjectsV2(params).promise().then(function (objects) {
            const { Key, LastModified } = objects.Contents[0];
            expect(Key).toEqual("lymph--hello-commands.zip");
            expect(new Date(LastModified).getTime())
                .toBeLessThanOrEqual(time_stamp);
        });
    });
});
test("updating and publishing function", function () {
    const lambda = new AWS.Lambda({ region: bundle_config.region });
    const invoke_options = {
        FunctionName: "lymph--hello-queries"
    };
    return lambda.getFunction(invoke_options).promise().then(function (prev_func_info) {
        return Services.updateFunction(bundle_config)(services).then(function () {
            return lambda.getFunction(invoke_options).promise().then(function (next_func_info) {
                expect(prev_func_info).not.toEqual(next_func_info);
            });
        });
    });
});
test("updating and publishing function", function () {
    const lambda = new AWS.Lambda({ region: bundle_config.region });
    const invoke_options = {
        FunctionName: "lymph--hello-queries"
    };
    return lambda.listVersionsByFunction(invoke_options).promise().then(function (response) {
        const prev_finger_prints = response.Versions.map(r => Object.assign({}, {
            [r.Version]: r.CodeSha256
        }));
        return Services.publishFunction(bundle_config)(services).then(function () {
            return lambda.listVersionsByFunction(invoke_options).promise().then(function (response) {
                const next_finger_prints = response.Versions.map(r => Object.assign({}, {
                    [r.Version]: r.CodeSha256
                }));
                expect(next_finger_prints.length).toBeGreaterThan(prev_finger_prints.length);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMudGVzdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50ZXN0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE4QjtBQUM5QiwrQkFBOEI7QUFJOUIsdUNBQXNDO0FBRXRDLG1DQUEwQztBQUcxQyxNQUFNLFVBQVUsR0FBRyxzQkFBc0IsQ0FBQTtBQUV6QyxNQUFNLGFBQWEsR0FBRztJQUNsQixTQUFTLEVBQUUsT0FBTztJQUNsQixRQUFRLEVBQUUsZ0JBQWdCO0lBQzFCLFNBQVMsRUFBRSxVQUFVO0lBQ3JCLE1BQU0sRUFBRSxXQUFXO0NBQ3RCLENBQUE7QUFFRCxNQUFNLFFBQVEsR0FBRztJQUNiLHdDQUF3QztJQUN4Qyx1Q0FBdUM7Q0FDMUMsQ0FBQTtBQUVELFFBQVEsQ0FBRSx3QkFBZ0IsQ0FBRSxVQUFVLENBQUUsQ0FBRSxDQUFBO0FBRTFDLElBQUksQ0FBRSxvQkFBb0IsRUFBRTtJQUN4QixNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBRSxhQUFhLENBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxpQkFBaUI7UUFDdEUsTUFBTSxDQUFFLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFFLENBQUMsT0FBTyxDQUFFLFFBQVEsQ0FBRSxDQUFBO0lBQzFELENBQUMsQ0FBRSxDQUFBO0FBQ1AsQ0FBQyxDQUFFLENBQUE7QUFFSCxJQUFJLENBQUUsa0RBQWtELEVBQUU7SUFDdEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUUsYUFBYSxDQUFFLENBQUUsUUFBUSxDQUFFLENBQUMsSUFBSSxDQUFFO1FBQ3ZELE1BQU0sQ0FBQyxJQUFJLENBQUUsYUFBYSxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxLQUFlO1lBQy9FLE1BQU0sQ0FBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUUsQ0FBQyxPQUFPLENBQUU7Z0JBQzVCLGdEQUFnRDtnQkFDaEQsaURBQWlE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cnQgKiBhcyBBV1MgZnJvbSBcImF3cy1zZGtcIlxuXG5pbXBvcnQgeyBIVFRQIH0gZnJvbSBcImx5bXBoLXNlcnZpY2VcIlxuXG5pbXBvcnQgKiBhcyBTZXJ2aWNlcyBmcm9tIFwiLi9TZXJ2aWNlc1wiXG5cbmltcG9ydCB7IHJlbW92ZUFsbEpTRmlsZXMgfSBmcm9tIFwiLi9VdGlsc1wiXG5pbXBvcnQgeyBMaXN0T2JqZWN0c1YyUmVxdWVzdCB9IGZyb20gXCJhd3Mtc2RrL2NsaWVudHMvczNcIlxuXG5jb25zdCBzb3VyY2VfZGlyID0gXCJzcmMvc2FtcGxlcy9zZXJ2aWNlc1wiXG5cbmNvbnN0IGJ1bmRsZV9jb25maWcgPSB7XG4gICAgbmFtZXNwYWNlOiBcImx5bXBoXCIsXG4gICAgYnVpbGREaXI6IFwiYnVpbGQvc2VydmljZXNcIixcbiAgICBzb3VyY2VEaXI6IHNvdXJjZV9kaXIsXG4gICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiXG59XG5cbmNvbnN0IHNlcnZpY2VzID0gW1xuICAgIFwic3JjL3NhbXBsZXMvc2VydmljZXMvaGVsbG8tY29tbWFuZHMudHNcIixcbiAgICBcInNyYy9zYW1wbGVzL3NlcnZpY2VzL2hlbGxvLXF1ZXJpZXMudHNcIlxuXVxuXG5hZnRlckFsbCggcmVtb3ZlQWxsSlNGaWxlcyggc291cmNlX2RpciApIClcblxudGVzdCggXCJkZXRlY3Rpbmcgc2VydmljZXNcIiwgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBTZXJ2aWNlcy5kZXRlY3QoIGJ1bmRsZV9jb25maWcgKS50aGVuKCBmdW5jdGlvbiAoIGRldGVjdGVkX3NlcnZpY2VzICkge1xuICAgICAgICBleHBlY3QoIGRldGVjdGVkX3NlcnZpY2VzLnNvcnQoKSApLnRvRXF1YWwoIHNlcnZpY2VzIClcbiAgICB9IClcbn0gKVxuXG50ZXN0KCBcImNvbXBpbGluZyBzZXJ2aWNlcyB0byBzZXBhcmF0ZSBidWlsZCBkaXJlY3Rvcmllc1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFNlcnZpY2VzLmNvbXBpbGUoIGJ1bmRsZV9jb25maWcgKSggc2VydmljZXMgKS50aGVuKCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBHbG9iKCBidW5kbGVfY29uZmlnLmJ1aWxkRGlyICsgXCIvKiovKi5qc1wiICkudGhlbiggZnVuY3Rpb24gKCBmaWxlczogc3RyaW5nW10gKSB7XG4gICAgICAgICAgICBleHBlY3QoIGZpbGVzLnNvcnQoKSApLnRvRXF1YWwoIFtcbiAgICAgICAgICAgICAgICBcImJ1aWxkL3NlcnZpY2VzL2hlbGxvLWNvbW1hbmRzL2NvbW1vbi9MYW1iZGEuanNcIixcbiAgICAgICAgICAgICAgICBcImJ1aWxkL3NlcnZpY2VzL2hlbGxvLWNvbW1hbmRzL2hlbGxvLWNvbW1hbmRzLmpzXCIsXG4gICAgICAgICAgICAgICAgXCJidWlsZC9zZXJ2aWNlcy9oZWxsby1xdWVyaWVzL2hlbGxvLXF1ZXJpZXMuanNcIixcbiAgICAgICAgICAgIF0gKVxuICAgICAgICB9IClcbiAgICB9IClcbn0gKVxuXG50ZXN0KCBcImJ1bmRsaW5nIHNlcnZpY2VzIGludG8gemlwIGZpbGVzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gU2VydmljZXMuYnVuZGxlKCBidW5kbGVfY29uZmlnICkoIHNlcnZpY2VzICkudGhlbiggZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gR2xvYiggYnVuZGxlX2NvbmZpZy5idWlsZERpciArIFwiLyouemlwXCIgKS50aGVuKCBmdW5jdGlvbiAoIGZpbGVzOiBzdHJpbmdbXSApIHtcbiAgICAgICAgICAgIGV4cGVjdCggZmlsZXMuc29ydCgpICkudG9FcXVhbCggW1xuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvbHltcGgtLWhlbGxvLWNvbW1hbmRzLnppcFwiLFxuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvbHltcGgtLWhlbGxvLXF1ZXJpZXMuemlwXCIsXG4gICAgICAgICAgICBdIClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGxvYWQgc2VydmljZSBidW5kbGVzIHRvIHMzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBTMyA9IG5ldyBBV1MuUzMoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcbiAgICBjb25zdCB0aW1lX3N0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSAxODAwMDAgLy8gMiBtaW51dGUgYnVmZmVyXG5cbiAgICByZXR1cm4gU2VydmljZXMudXBsb2FkRnVuY3Rpb24oIGJ1bmRsZV9jb25maWcgKSggc2VydmljZXMgKS50aGVuKCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtczogTGlzdE9iamVjdHNWMlJlcXVlc3QgPSB7IEJ1Y2tldDogXCJseW1waC1hcnRpZmFjdHNcIiB9XG5cbiAgICAgICAgcmV0dXJuIFMzLmxpc3RPYmplY3RzVjIoIHBhcmFtcyApLnByb21pc2UoKS50aGVuKCBmdW5jdGlvbiAoIG9iamVjdHMgKSB7XG4gICAgICAgICAgICBjb25zdCB7IEtleSwgTGFzdE1vZGlmaWVkIH0gPSBvYmplY3RzLkNvbnRlbnRzWyAwIF1cblxuICAgICAgICAgICAgZXhwZWN0KCBLZXkgKS50b0VxdWFsKCBcImx5bXBoLS1oZWxsby1jb21tYW5kcy56aXBcIiApXG4gICAgICAgICAgICBleHBlY3QoIG5ldyBEYXRlKCBMYXN0TW9kaWZpZWQgKS5nZXRUaW1lKCkgKVxuICAgICAgICAgICAgICAgIC50b0JlTGVzc1RoYW5PckVxdWFsKCB0aW1lX3N0YW1wIClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGRhdGluZyBhbmQgcHVibGlzaGluZyBmdW5jdGlvblwiLCBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcblxuICAgIGNvbnN0IGludm9rZV9vcHRpb25zID0ge1xuICAgICAgICBGdW5jdGlvbk5hbWU6IFwibHltcGgtLWhlbGxvLXF1ZXJpZXNcIlxuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGEuZ2V0RnVuY3Rpb24oIGludm9rZV9vcHRpb25zICkucHJvbWlzZSgpLnRoZW4oIGZ1bmN0aW9uICggcHJldl9mdW5jX2luZm8gKSB7XG4gICAgICAgIHJldHVybiBTZXJ2aWNlcy51cGRhdGVGdW5jdGlvbiggYnVuZGxlX2NvbmZpZyApKCBzZXJ2aWNlcyApLnRoZW4oIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBsYW1iZGEuZ2V0RnVuY3Rpb24oIGludm9rZV9vcHRpb25zICkucHJvbWlzZSgpLnRoZW4oIGZ1bmN0aW9uICggbmV4dF9mdW5jX2luZm8gKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KCBwcmV2X2Z1bmNfaW5mbyApLm5vdC50b0VxdWFsKCBuZXh0X2Z1bmNfaW5mbyApXG4gICAgICAgICAgICB9IClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGRhdGluZyBhbmQgcHVibGlzaGluZyBmdW5jdGlvblwiLCBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcblxuICAgIGNvbnN0IGludm9rZV9vcHRpb25zID0ge1xuICAgICAgICBGdW5jdGlvbk5hbWU6IFwibHltcGgtLWhlbGxvLXF1ZXJpZXNcIlxuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGEubGlzdFZlcnNpb25zQnlGdW5jdGlvbiggaW52b2tlX29wdGlvbnMgKS5wcm9taXNlKCkudGhlbiggZnVuY3Rpb24gKCByZXNwb25zZSApIHtcbiAgICAgICAgY29uc3QgcHJldl9maW5nZXJfcHJpbnRzID0gcmVzcG9uc2UuVmVyc2lvbnMubWFwKCByID0+IE9iamVjdC5hc3NpZ24oIHt9LCB7XG4gICAgICAgICAgICBbIHIuVmVyc2lvbiBdOiByLkNvZGVTaGEyNTZcbiAgICAgICAgfSApIClcblxuICAgICAgICByZXR1cm4gU2VydmljZXMucHVibGlzaEZ1bmN0aW9uKCBidW5kbGVfY29uZmlnICkoIHNlcnZpY2VzICkudGhlbiggZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIGxhbWJkYS5saXN0VmVyc2lvbnNCeUZ1bmN0aW9uKCBpbnZva2Vfb3B0aW9ucyApLnByb21pc2UoKS50aGVuKCBmdW5jdGlvbiAoIHJlc3BvbnNlICkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRfZmluZ2VyX3ByaW50cyA9IHJlc3BvbnNlLlZlcnNpb25zLm1hcCggciA9PiBPYmplY3QuYXNzaWduKCB7fSwge1xuICAgICAgICAgICAgICAgICAgICBbIHIuVmVyc2lvbiBdOiByLkNvZGVTaGEyNTZcbiAgICAgICAgICAgICAgICB9ICkgKVxuXG4gICAgICAgICAgICAgICAgZXhwZWN0KCBuZXh0X2Zpbmdlcl9wcmludHMubGVuZ3RoICkudG9CZUdyZWF0ZXJUaGFuKCBwcmV2X2Zpbmdlcl9wcmludHMubGVuZ3RoIClcbiAgICAgICAgICAgIH0gKVxuICAgICAgICB9IClcbiAgICB9IClcbn0gKVxuIl19