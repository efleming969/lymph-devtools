"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Glob = require("globby");
const AWS = require("aws-sdk");
const Services = require("./Services");
const Utils_1 = require("./Utils");
const source_dir = "src/samples/services";
const bundle_config = {
    namespace: "lymph",
    buildDir: "build/services",
    sourceDir: source_dir,
    region: "us-east-1"
};
const services = [
    "src/samples/services/hello-commands.ts",
    "src/samples/services/hello-queries.ts"
];
jest.setTimeout(10000);
afterAll(Utils_1.removeAllJSFiles(source_dir));
test("detecting services", function () {
    return Services.detect(bundle_config).then(function (detected_services) {
        expect(detected_services.sort()).toEqual(services);
    });
});
test("compiling services to separate build directory", function () {
    return Services.compile(bundle_config)(services).then(function () {
        return Glob(bundle_config.buildDir + "/pre/**/*.js").then(function (files) {
            expect(files.sort()).toEqual([
                "build/services/pre/common/Lambda.js",
                "build/services/pre/hello-commands.js",
                "build/services/pre/hello-queries.js",
            ]);
        });
    });
});
test("bundling services to a single js file", function () {
    return Services.bundle(bundle_config)(services).then(function () {
        return Glob(bundle_config.buildDir + "/*.js").then(function (files) {
            expect(files.sort()).toEqual([
                "build/services/hello-commands.js",
                "build/services/hello-queries.js",
            ]);
        });
    });
});
test("archive services into zip files", function () {
    return Services.archive(bundle_config)(services).then(function () {
        return Glob(bundle_config.buildDir + "/*.zip").then(function (files) {
            expect(files.sort()).toEqual([
                "build/services/lymph--hello-commands.zip",
                "build/services/lymph--hello-queries.zip",
            ]);
        });
    });
});
test("upload service bundles to s3", function () {
    const S3 = new AWS.S3({ region: bundle_config.region });
    const time_stamp = new Date().getTime() - 180000; // 2 minute buffer
    return Services.uploadFunction(bundle_config)(services).then(function () {
        const params = { Bucket: "lymph-artifacts" };
        return S3.listObjectsV2(params).promise().then(function (objects) {
            const { Key, LastModified } = objects.Contents[0];
            expect(Key).toEqual("lymph--hello-commands.zip");
            expect(new Date(LastModified).getTime())
                .toBeLessThanOrEqual(time_stamp);
        });
    });
});
test("updating and publishing function", function () {
    const lambda = new AWS.Lambda({ region: bundle_config.region });
    const invoke_options = {
        FunctionName: "lymph--hello-queries"
    };
    return lambda.getFunction(invoke_options).promise().then(function (prev_func_info) {
        return Services.updateFunction(bundle_config)(services).then(function () {
            return lambda.getFunction(invoke_options).promise().then(function (next_func_info) {
                expect(prev_func_info).not.toEqual(next_func_info);
            });
        });
    });
});
test("updating and publishing function", function () {
    const lambda = new AWS.Lambda({ region: bundle_config.region });
    const invoke_options = {
        FunctionName: "lymph--hello-queries"
    };
    return lambda.listVersionsByFunction(invoke_options).promise().then(function (response) {
        const prev_finger_prints = response.Versions.map(r => Object.assign({}, {
            [r.Version]: r.CodeSha256
        }));
        return Services.publishFunction(bundle_config)(services).then(function () {
            return lambda.listVersionsByFunction(invoke_options).promise().then(function (response) {
                const next_finger_prints = response.Versions.map(r => Object.assign({}, {
                    [r.Version]: r.CodeSha256
                }));
                expect(next_finger_prints.length).toBeGreaterThan(prev_finger_prints.length);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZXMudGVzdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXJ2aWNlcy50ZXN0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE4QjtBQUM5QiwrQkFBOEI7QUFJOUIsdUNBQXNDO0FBRXRDLG1DQUEwQztBQUcxQyxNQUFNLFVBQVUsR0FBRyxzQkFBc0IsQ0FBQTtBQUV6QyxNQUFNLGFBQWEsR0FBRztJQUNsQixTQUFTLEVBQUUsT0FBTztJQUNsQixRQUFRLEVBQUUsZ0JBQWdCO0lBQzFCLFNBQVMsRUFBRSxVQUFVO0lBQ3JCLE1BQU0sRUFBRSxXQUFXO0NBQ3RCLENBQUE7QUFFRCxNQUFNLFFBQVEsR0FBRztJQUNiLHdDQUF3QztJQUN4Qyx1Q0FBdUM7Q0FDMUMsQ0FBQTtBQUVELElBQUksQ0FBQyxVQUFVLENBQUUsS0FBSyxDQUFFLENBQUE7QUFFeEIsUUFBUSxDQUFFLHdCQUFnQixDQUFFLFVBQVUsQ0FBRSxDQUFFLENBQUE7QUFFMUMsSUFBSSxDQUFFLG9CQUFvQixFQUFFO0lBQ3hCLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFFLGFBQWEsQ0FBRSxDQUFDLElBQUksQ0FBRSxVQUFXLGlCQUFpQjtRQUN0RSxNQUFNLENBQUUsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUUsQ0FBQyxPQUFPLENBQUUsUUFBUSxDQUFFLENBQUE7SUFDMUQsQ0FBQyxDQUFFLENBQUE7QUFDUCxDQUFDLENBQUUsQ0FBQTtBQUVILElBQUksQ0FBRSxnREFBZ0QsRUFBRTtJQUNwRCxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBRSxhQUFhLENBQUUsQ0FBRSxRQUFRLENBQUUsQ0FBQyxJQUFJLENBQUU7UUFDdkQsTUFBTSxDQUFDLElBQUksQ0FBRSxhQUFhLENBQUMsUUFBUSxHQUFHLGNBQWMsQ0FBRSxDQUFDLElBQUksQ0FBRSxVQUFXLEtBQWU7WUFDbkYsTUFBTSxDQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBRSxDQUFDLE9BQU8sQ0FBRTtnQkFDNUIscUNBQXFDO2dCQUNyQyxzQ0FBc0M7Z0JBQ3RDLHFDQUFxQzthQUN4QyxDQUFFLENBQUE7UUFDUCxDQUFDLENBQUUsQ0FBQTtJQUNQLENBQUMsQ0FBRSxDQUFBO0FBQ1AsQ0FBQyxDQUFFLENBQUE7QUFFSCxJQUFJLENBQUUsdUNBQXVDLEVBQUU7SUFDM0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUUsYUFBYSxDQUFFLENBQUUsUUFBUSxDQUFFLENBQUMsSUFBSSxDQUFFO1FBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQUUsYUFBYSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxLQUFlO1lBQzVFLE1BQU0sQ0FBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUUsQ0FBQyxPQUFPLENBQUU7Z0JBQzVCLGtDQUFrQztnQkFDbEMsaUNBQWlDO2FBQ3BDLENBQUUsQ0FBQTtRQUNQLENBQUMsQ0FBRSxDQUFBO0lBQ1AsQ0FBQyxDQUFFLENBQUE7QUFDUCxDQUFDLENBQUUsQ0FBQTtBQUVILElBQUksQ0FBRSxpQ0FBaUMsRUFBRTtJQUNyQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBRSxhQUFhLENBQUUsQ0FBRSxRQUFRLENBQUUsQ0FBQyxJQUFJLENBQUU7UUFDdkQsTUFBTSxDQUFDLElBQUksQ0FBRSxhQUFhLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBRSxDQUFDLElBQUksQ0FBRSxVQUFXLEtBQWU7WUFDN0UsTUFBTSxDQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBRSxDQUFDLE9BQU8sQ0FBRTtnQkFDNUIsMENBQTBDO2dCQUMxQyx5Q0FBeUM7YUFDNUMsQ0FBRSxDQUFBO1FBQ1AsQ0FBQyxDQUFFLENBQUE7SUFDUCxDQUFDLENBQUUsQ0FBQTtBQUNQLENBQUMsQ0FBRSxDQUFBO0FBRUgsSUFBSSxDQUFFLDhCQUE4QixFQUFFO0lBQ2xDLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtJQUN6RCxNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFHLE1BQU0sQ0FBQSxDQUFDLGtCQUFrQjtJQUVuRSxNQUFNLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBRSxhQUFhLENBQUUsQ0FBRSxRQUFRLENBQUUsQ0FBQyxJQUFJLENBQUU7UUFDOUQsTUFBTSxNQUFNLEdBQXlCLEVBQUUsTUFBTSxFQUFFLGlCQUFpQixFQUFFLENBQUE7UUFFbEUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUUsTUFBTSxDQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFFLFVBQVcsT0FBTztZQUNoRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUUsQ0FBQyxDQUFFLENBQUE7WUFFbkQsTUFBTSxDQUFFLEdBQUcsQ0FBRSxDQUFDLE9BQU8sQ0FBRSwyQkFBMkIsQ0FBRSxDQUFBO1lBQ3BELE1BQU0sQ0FBRSxJQUFJLElBQUksQ0FBRSxZQUFZLENBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBRTtpQkFDdkMsbUJBQW1CLENBQUUsVUFBVSxDQUFFLENBQUE7UUFDMUMsQ0FBQyxDQUFFLENBQUE7SUFDUCxDQUFDLENBQUUsQ0FBQTtBQUNQLENBQUMsQ0FBRSxDQUFBO0FBRUgsSUFBSSxDQUFFLGtDQUFrQyxFQUFFO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUUsQ0FBQTtJQUVqRSxNQUFNLGNBQWMsR0FBRztRQUNuQixZQUFZLEVBQUUsc0JBQXNCO0tBQ3ZDLENBQUE7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBRSxjQUFjLENBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxjQUFjO1FBQ2pGLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFFLGFBQWEsQ0FBRSxDQUFFLFFBQVEsQ0FBRSxDQUFDLElBQUksQ0FBRTtZQUM5RCxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBRSxjQUFjLENBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxjQUFjO2dCQUNqRixNQUFNLENBQUUsY0FBYyxDQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBRSxjQUFjLENBQUUsQ0FBQTtZQUMxRCxDQUFDLENBQUUsQ0FBQTtRQUNQLENBQUMsQ0FBRSxDQUFBO0lBQ1AsQ0FBQyxDQUFFLENBQUE7QUFDUCxDQUFDLENBQUUsQ0FBQTtBQUVILElBQUksQ0FBRSxrQ0FBa0MsRUFBRTtJQUN0QyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUUsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFFLENBQUE7SUFFakUsTUFBTSxjQUFjLEdBQUc7UUFDbkIsWUFBWSxFQUFFLHNCQUFzQjtLQUN2QyxDQUFBO0lBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBRSxjQUFjLENBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUUsVUFBVyxRQUFRO1FBQ3RGLE1BQU0sa0JBQWtCLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFFLEVBQUUsRUFBRTtZQUN0RSxDQUFFLENBQUMsQ0FBQyxPQUFPLENBQUUsRUFBRSxDQUFDLENBQUMsVUFBVTtTQUM5QixDQUFFLENBQUUsQ0FBQTtRQUVMLE1BQU0sQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFFLGFBQWEsQ0FBRSxDQUFFLFFBQVEsQ0FBRSxDQUFDLElBQUksQ0FBRTtZQUMvRCxNQUFNLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFFLGNBQWMsQ0FBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBRSxVQUFXLFFBQVE7Z0JBQ3RGLE1BQU0sa0JBQWtCLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFFLEVBQUUsRUFBRTtvQkFDdEUsQ0FBRSxDQUFDLENBQUMsT0FBTyxDQUFFLEVBQUUsQ0FBQyxDQUFDLFVBQVU7aUJBQzlCLENBQUUsQ0FBRSxDQUFBO2dCQUVMLE1BQU0sQ0FBRSxrQkFBa0IsQ0FBQyxNQUFNLENBQUUsQ0FBQyxlQUFlLENBQUUsa0JBQWtCLENBQUMsTUFBTSxDQUFFLENBQUE7WUFDcEYsQ0FBQyxDQUFFLENBQUE7UUFDUCxDQUFDLENBQUUsQ0FBQTtJQUNQLENBQUMsQ0FBRSxDQUFBO0FBQ1AsQ0FBQyxDQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBHbG9iIGZyb20gXCJnbG9iYnlcIlxuaW1wb3J0ICogYXMgQVdTIGZyb20gXCJhd3Mtc2RrXCJcblxuaW1wb3J0IHsgSFRUUCB9IGZyb20gXCJseW1waC1zZXJ2aWNlXCJcblxuaW1wb3J0ICogYXMgU2VydmljZXMgZnJvbSBcIi4vU2VydmljZXNcIlxuXG5pbXBvcnQgeyByZW1vdmVBbGxKU0ZpbGVzIH0gZnJvbSBcIi4vVXRpbHNcIlxuaW1wb3J0IHsgTGlzdE9iamVjdHNWMlJlcXVlc3QgfSBmcm9tIFwiYXdzLXNkay9jbGllbnRzL3MzXCJcblxuY29uc3Qgc291cmNlX2RpciA9IFwic3JjL3NhbXBsZXMvc2VydmljZXNcIlxuXG5jb25zdCBidW5kbGVfY29uZmlnID0ge1xuICAgIG5hbWVzcGFjZTogXCJseW1waFwiLFxuICAgIGJ1aWxkRGlyOiBcImJ1aWxkL3NlcnZpY2VzXCIsXG4gICAgc291cmNlRGlyOiBzb3VyY2VfZGlyLFxuICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIlxufVxuXG5jb25zdCBzZXJ2aWNlcyA9IFtcbiAgICBcInNyYy9zYW1wbGVzL3NlcnZpY2VzL2hlbGxvLWNvbW1hbmRzLnRzXCIsXG4gICAgXCJzcmMvc2FtcGxlcy9zZXJ2aWNlcy9oZWxsby1xdWVyaWVzLnRzXCJcbl1cblxuamVzdC5zZXRUaW1lb3V0KCAxMDAwMCApXG5cbmFmdGVyQWxsKCByZW1vdmVBbGxKU0ZpbGVzKCBzb3VyY2VfZGlyICkgKVxuXG50ZXN0KCBcImRldGVjdGluZyBzZXJ2aWNlc1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFNlcnZpY2VzLmRldGVjdCggYnVuZGxlX2NvbmZpZyApLnRoZW4oIGZ1bmN0aW9uICggZGV0ZWN0ZWRfc2VydmljZXMgKSB7XG4gICAgICAgIGV4cGVjdCggZGV0ZWN0ZWRfc2VydmljZXMuc29ydCgpICkudG9FcXVhbCggc2VydmljZXMgKVxuICAgIH0gKVxufSApXG5cbnRlc3QoIFwiY29tcGlsaW5nIHNlcnZpY2VzIHRvIHNlcGFyYXRlIGJ1aWxkIGRpcmVjdG9yeVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFNlcnZpY2VzLmNvbXBpbGUoIGJ1bmRsZV9jb25maWcgKSggc2VydmljZXMgKS50aGVuKCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBHbG9iKCBidW5kbGVfY29uZmlnLmJ1aWxkRGlyICsgXCIvcHJlLyoqLyouanNcIiApLnRoZW4oIGZ1bmN0aW9uICggZmlsZXM6IHN0cmluZ1tdICkge1xuICAgICAgICAgICAgZXhwZWN0KCBmaWxlcy5zb3J0KCkgKS50b0VxdWFsKCBbXG4gICAgICAgICAgICAgICAgXCJidWlsZC9zZXJ2aWNlcy9wcmUvY29tbW9uL0xhbWJkYS5qc1wiLFxuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvcHJlL2hlbGxvLWNvbW1hbmRzLmpzXCIsXG4gICAgICAgICAgICAgICAgXCJidWlsZC9zZXJ2aWNlcy9wcmUvaGVsbG8tcXVlcmllcy5qc1wiLFxuICAgICAgICAgICAgXSApXG4gICAgICAgIH0gKVxuICAgIH0gKVxufSApXG5cbnRlc3QoIFwiYnVuZGxpbmcgc2VydmljZXMgdG8gYSBzaW5nbGUganMgZmlsZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFNlcnZpY2VzLmJ1bmRsZSggYnVuZGxlX2NvbmZpZyApKCBzZXJ2aWNlcyApLnRoZW4oIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIEdsb2IoIGJ1bmRsZV9jb25maWcuYnVpbGREaXIgKyBcIi8qLmpzXCIgKS50aGVuKCBmdW5jdGlvbiAoIGZpbGVzOiBzdHJpbmdbXSApIHtcbiAgICAgICAgICAgIGV4cGVjdCggZmlsZXMuc29ydCgpICkudG9FcXVhbCggW1xuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvaGVsbG8tY29tbWFuZHMuanNcIixcbiAgICAgICAgICAgICAgICBcImJ1aWxkL3NlcnZpY2VzL2hlbGxvLXF1ZXJpZXMuanNcIixcbiAgICAgICAgICAgIF0gKVxuICAgICAgICB9IClcbiAgICB9IClcbn0gKVxuXG50ZXN0KCBcImFyY2hpdmUgc2VydmljZXMgaW50byB6aXAgZmlsZXNcIiwgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBTZXJ2aWNlcy5hcmNoaXZlKCBidW5kbGVfY29uZmlnICkoIHNlcnZpY2VzICkudGhlbiggZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gR2xvYiggYnVuZGxlX2NvbmZpZy5idWlsZERpciArIFwiLyouemlwXCIgKS50aGVuKCBmdW5jdGlvbiAoIGZpbGVzOiBzdHJpbmdbXSApIHtcbiAgICAgICAgICAgIGV4cGVjdCggZmlsZXMuc29ydCgpICkudG9FcXVhbCggW1xuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvbHltcGgtLWhlbGxvLWNvbW1hbmRzLnppcFwiLFxuICAgICAgICAgICAgICAgIFwiYnVpbGQvc2VydmljZXMvbHltcGgtLWhlbGxvLXF1ZXJpZXMuemlwXCIsXG4gICAgICAgICAgICBdIClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGxvYWQgc2VydmljZSBidW5kbGVzIHRvIHMzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBTMyA9IG5ldyBBV1MuUzMoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcbiAgICBjb25zdCB0aW1lX3N0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSAxODAwMDAgLy8gMiBtaW51dGUgYnVmZmVyXG5cbiAgICByZXR1cm4gU2VydmljZXMudXBsb2FkRnVuY3Rpb24oIGJ1bmRsZV9jb25maWcgKSggc2VydmljZXMgKS50aGVuKCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtczogTGlzdE9iamVjdHNWMlJlcXVlc3QgPSB7IEJ1Y2tldDogXCJseW1waC1hcnRpZmFjdHNcIiB9XG5cbiAgICAgICAgcmV0dXJuIFMzLmxpc3RPYmplY3RzVjIoIHBhcmFtcyApLnByb21pc2UoKS50aGVuKCBmdW5jdGlvbiAoIG9iamVjdHMgKSB7XG4gICAgICAgICAgICBjb25zdCB7IEtleSwgTGFzdE1vZGlmaWVkIH0gPSBvYmplY3RzLkNvbnRlbnRzWyAwIF1cblxuICAgICAgICAgICAgZXhwZWN0KCBLZXkgKS50b0VxdWFsKCBcImx5bXBoLS1oZWxsby1jb21tYW5kcy56aXBcIiApXG4gICAgICAgICAgICBleHBlY3QoIG5ldyBEYXRlKCBMYXN0TW9kaWZpZWQgKS5nZXRUaW1lKCkgKVxuICAgICAgICAgICAgICAgIC50b0JlTGVzc1RoYW5PckVxdWFsKCB0aW1lX3N0YW1wIClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGRhdGluZyBhbmQgcHVibGlzaGluZyBmdW5jdGlvblwiLCBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcblxuICAgIGNvbnN0IGludm9rZV9vcHRpb25zID0ge1xuICAgICAgICBGdW5jdGlvbk5hbWU6IFwibHltcGgtLWhlbGxvLXF1ZXJpZXNcIlxuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGEuZ2V0RnVuY3Rpb24oIGludm9rZV9vcHRpb25zICkucHJvbWlzZSgpLnRoZW4oIGZ1bmN0aW9uICggcHJldl9mdW5jX2luZm8gKSB7XG4gICAgICAgIHJldHVybiBTZXJ2aWNlcy51cGRhdGVGdW5jdGlvbiggYnVuZGxlX2NvbmZpZyApKCBzZXJ2aWNlcyApLnRoZW4oIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBsYW1iZGEuZ2V0RnVuY3Rpb24oIGludm9rZV9vcHRpb25zICkucHJvbWlzZSgpLnRoZW4oIGZ1bmN0aW9uICggbmV4dF9mdW5jX2luZm8gKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KCBwcmV2X2Z1bmNfaW5mbyApLm5vdC50b0VxdWFsKCBuZXh0X2Z1bmNfaW5mbyApXG4gICAgICAgICAgICB9IClcbiAgICAgICAgfSApXG4gICAgfSApXG59IClcblxudGVzdCggXCJ1cGRhdGluZyBhbmQgcHVibGlzaGluZyBmdW5jdGlvblwiLCBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoIHsgcmVnaW9uOiBidW5kbGVfY29uZmlnLnJlZ2lvbiB9IClcblxuICAgIGNvbnN0IGludm9rZV9vcHRpb25zID0ge1xuICAgICAgICBGdW5jdGlvbk5hbWU6IFwibHltcGgtLWhlbGxvLXF1ZXJpZXNcIlxuICAgIH1cblxuICAgIHJldHVybiBsYW1iZGEubGlzdFZlcnNpb25zQnlGdW5jdGlvbiggaW52b2tlX29wdGlvbnMgKS5wcm9taXNlKCkudGhlbiggZnVuY3Rpb24gKCByZXNwb25zZSApIHtcbiAgICAgICAgY29uc3QgcHJldl9maW5nZXJfcHJpbnRzID0gcmVzcG9uc2UuVmVyc2lvbnMubWFwKCByID0+IE9iamVjdC5hc3NpZ24oIHt9LCB7XG4gICAgICAgICAgICBbIHIuVmVyc2lvbiBdOiByLkNvZGVTaGEyNTZcbiAgICAgICAgfSApIClcblxuICAgICAgICByZXR1cm4gU2VydmljZXMucHVibGlzaEZ1bmN0aW9uKCBidW5kbGVfY29uZmlnICkoIHNlcnZpY2VzICkudGhlbiggZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIGxhbWJkYS5saXN0VmVyc2lvbnNCeUZ1bmN0aW9uKCBpbnZva2Vfb3B0aW9ucyApLnByb21pc2UoKS50aGVuKCBmdW5jdGlvbiAoIHJlc3BvbnNlICkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRfZmluZ2VyX3ByaW50cyA9IHJlc3BvbnNlLlZlcnNpb25zLm1hcCggciA9PiBPYmplY3QuYXNzaWduKCB7fSwge1xuICAgICAgICAgICAgICAgICAgICBbIHIuVmVyc2lvbiBdOiByLkNvZGVTaGEyNTZcbiAgICAgICAgICAgICAgICB9ICkgKVxuXG4gICAgICAgICAgICAgICAgZXhwZWN0KCBuZXh0X2Zpbmdlcl9wcmludHMubGVuZ3RoICkudG9CZUdyZWF0ZXJUaGFuKCBwcmV2X2Zpbmdlcl9wcmludHMubGVuZ3RoIClcbiAgICAgICAgICAgIH0gKVxuICAgICAgICB9IClcbiAgICB9IClcbn0gKVxuIl19